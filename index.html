<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Horários - IFRO Campus Cacoal (Multianual)</title>
    <!-- Carrega o Tailwind CSS para o estilo responsivo e moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'ifro-primary': '#16A34A', 
                        'ifro-light': '#F3F4F6',
                    }
                }
            }
        }
    </script>
    <!-- Scripts para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="bg-ifro-light font-sans min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-xl container-shadow overflow-hidden">
        
        <!-- CABEÇALHO INSTITUCIONAL -->
        <header class="header-bg p-6 text-center rounded-t-xl">
            <h1 class="text-3xl font-extrabold mb-1">INSTITUTO FEDERAL DE RONDÔNIA</h1>
            <h2 class="text-2xl font-semibold italic mb-4">CAMPUS CACOAL</h2>
            <div class="h-0.5 bg-white opacity-20 mx-auto w-3/4 mb-4"></div>
            <p class="text-sm font-light mb-1">DEPARTAMENTO DE APOIO AO ENSINO</p>
            <p class="text-sm font-medium">COORDENAÇÃO DE DESENVOLVIMENTO DE FERRAMENTAS PEDAGÓGICAS</p>
        </header>

        <!-- CORPO DA CONSULTA -->
        <main class="p-6 md:p-8">
            <h3 class="text-xl font-bold text-gray-800 mb-6 border-b pb-2">Consulta de Horários por Ano, Turma e Disciplina</h3>
            
            <!-- INDICADOR DE CARREGAMENTO -->
            <div id="loadingIndicator" class="text-center p-4 bg-ifro-light rounded-lg font-bold text-ifro-primary">
                A carregar dados iniciais...
            </div>

            <!-- ÁREA DE FILTROS (AGORA COM 3 COLUNAS EM TELAS GRANDES) -->
            <div id="filterArea" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 mb-8 hidden">
                
                <!-- 1. SELETOR DE ANO -->
                <div>
                    <label for="yearSelect" class="block text-sm font-bold text-gray-700 mb-1">ANO LETIVO</label>
                    <select id="yearSelect" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-ifro-primary focus:border-ifro-primary transition duration-150 ease-in-out">
                        <!-- Opções preenchidas via JavaScript -->
                    </select>
                </div>

                <!-- 2. SELETOR DE TURMA -->
                <div>
                    <label for="turmaSelect" class="block text-sm font-bold text-gray-700 mb-1">TURMA</label>
                    <select id="turmaSelect" disabled class="w-full p-3 border border-gray-300 bg-gray-100 rounded-lg shadow-sm focus:ring-ifro-primary focus:border-ifro-primary transition duration-150 ease-in-out">
                        <option value="">-- Selecione a Turma --</option>
                    </select>
                </div>

                <!-- 3. SELETOR DE DISCIPLINA -->
                <div>
                    <label for="disciplinaSelect" class="block text-sm font-bold text-gray-700 mb-1">DISCIPLINA</label>
                    <select id="disciplinaSelect" disabled class="w-full p-3 border border-gray-300 bg-gray-100 rounded-lg shadow-sm focus:ring-ifro-primary focus:border-ifro-primary transition duration-150 ease-in-out">
                        <option value="">-- Selecione uma Disciplina --</option>
                    </select>
                </div>

                <!-- O seletor de Professor foi removido daqui, pois não é mais necessário para a filtragem -->
            </div>

            <!-- BOTÃO DE EXPORTAÇÃO E SUMÁRIO DE DIAS -->
            <div id="exportArea" class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8 p-4 bg-ifro-light rounded-lg border border-gray-200 hidden">
                <button id="exportPdfBtn" disabled class="w-full sm:w-auto px-6 py-3 text-lg font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 transition duration-150 ease-in-out shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                    Exportar Relatório em PDF
                </button>
                <div class="text-gray-700 text-base font-semibold">
                    <!-- Texto atualizado para refletir o total da disciplina -->
                    Total de Dias de Aula: <span id="totalDias" class="text-xl text-ifro-primary font-extrabold">0</span>
                </div>
            </div>

            <!-- TABELA DE RESULTADOS -->
            <div id="tableContainer" class="overflow-x-auto border border-gray-300 rounded-lg shadow-lg">
                <table id="horariosTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Mês</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Dia do Mês</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Dia da Semana</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Horário da Aula</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Professor</th> <!-- Coluna de Professor separada no relatório -->
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500 italic">Aguardando dados...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Mensagem de feedback -->
            <div id="feedbackMessage" class="hidden mt-4 p-3 rounded-lg text-center font-medium"></div>
        </main>

        <!-- RODAPÉ -->
        <footer class="p-4 bg-gray-100 text-center text-xs text-gray-600 border-t rounded-b-xl">
            <span id="dataRelatorio"></span> / Campus Cacoal
        </footer>

    </div>

    <script type="module">
        
        // =========================================================================
        // 1. CONFIGURAÇÃO DA FONTE DE DADOS (GIST)
        // =========================================================================
        
        const GIST_URLS = {
            '2025': 'https://gist.githubusercontent.com/jamilsalim-afk/5267c51cbe267bf1be19f89b481d4991/raw/98ecf9c281a99b846e8d03900026af13a71ffd0e/2025.csv', 
            // URL configurada como RAW (crua) do Gist
            '2026': 'https://gist.githubusercontent.com/jamilsalim-afk/9190f1ffef7618a7ccd8d2b82adb6b9e/raw/8c9680d8a4a623e634998f8a539f7e5ad9b3129a/gistfile1.csv',
            '2027': 'https://placeholder.com/2027_gist_url_csv', 
            '2028': 'https://placeholder.com/2028_gist_url_csv', 
            '2029': 'https://placeholder.com/2029_gist_url_csv', 
            '2030': 'https://placeholder.com/2030_gist_url_csv'  
        };
        
        const DEFAULT_YEAR = '2026';

        // Estrutura de Fallback (para testes se o Gist falhar)
        const fallbackScheduleData = [
            {A: "Setembro", B: "5", C: "Terça-feira", D: "19:00 - 20:40", E: "TADS - 2023", F: "Programação Web I - Prof. Jamil Salim"},
            // Adicionado um segundo professor para a mesma disciplina/turma para testar a nova funcionalidade
            {A: "Outubro", B: "12", C: "Quinta-feira", D: "19:00 - 20:40", E: "TADS - 2023", F: "Programação Web I - Prof. Ricardo Silva"},
            {A: "Setembro", B: "7", C: "Quinta-feira", D: "20:50 - 22:30", E: "TADS - 2023", F: "Banco de Dados I - Prof. Ana Paula"},
            {A: "Agosto", B: "10", C: "Segunda-feira", D: "07:30 - 09:10", E: "Agropecuária Integrado - 2024", F: "Matemática I - Prof. Carlos Souza"}
        ];

        // Mapeamento das colunas CSV para as chaves internas (A, B, C, D, E, F)
        const CSV_COLUMNS = ['A', 'B', 'C', 'D', 'E', 'F']; 
        
        // Delimitador padrão: PONTO E VÍRGULA (;)
        const CSV_DELIMITER = ';'; 

        // =========================================================================
        // 2. VARIÁVEIS DE ESTADO E REFERÊNCIAS DOM
        // =========================================================================
        
        let processedData = {};
        let currentSchedule = [];
        let currentYear = DEFAULT_YEAR; 
        
        // Referências aos elementos do DOM
        const yearSelect = document.getElementById('yearSelect'); 
        const turmaSelect = document.getElementById('turmaSelect');
        const disciplinaSelect = document.getElementById('disciplinaSelect');
        const tableBody = document.getElementById('tableBody');
        const totalDiasSpan = document.getElementById('totalDias');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const dataRelatorioSpan = document.getElementById('dataRelatorio');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const filterArea = document.getElementById('filterArea');
        const exportArea = document.getElementById('exportArea');
        
        // =========================================================================
        // 3. FUNÇÕES UTILITÁRIAS E CARREGAMENTO DE DADOS
        // =========================================================================

        /**
         * Converte o texto RAW de um CSV em uma array de objetos.
         */
        function parseCSV(csvText) {
            // 1. Normaliza as quebras de linha e remove colchetes (se ainda existirem)
            const normalizedText = csvText
                .replace(/\r\n/g, '\n').replace(/\r/g, '\n')
                .replace(/\[|\]/g, ''); 
            
            const lines = normalizedText.split('\n').filter(line => line.trim() !== '');
            
            if (lines.length <= 1) { 
                console.warn("CSV PARSER: O arquivo não contém linhas de dados válidas (apenas o cabeçalho ou está vazio).");
                return [];
            }

            // IGNORA A PRIMEIRA LINHA (CABECALHO)
            const dataLines = lines.slice(1); 
            const dataArray = [];

            for (const line of dataLines) {
                // Divide a linha pelo delimitador.
                const values = line.split(CSV_DELIMITER);
                
                const trimmedValues = values.map(v => (v || '').trim());
                
                if (trimmedValues.length < CSV_COLUMNS.length) {
                    console.warn(`CSV PARSER WARNING: Linha ignorada por número incorreto de colunas. Linha: ${line.substring(0, 100)}...`);
                    continue;
                }

                const dataObject = {};
                for (let i = 0; i < CSV_COLUMNS.length; i++) {
                    dataObject[CSV_COLUMNS[i]] = trimmedValues[i]; 
                }
                dataArray.push(dataObject);
            }
            console.log(`CSV PARSER SUCESSO: Foram analisadas ${dataArray.length} linhas de dados válidas.`);
            return dataArray;
        }

        /**
         * Gera um ID seguro para uso como chave.
         */
        function generateId(name) {
            return name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9\s-]/g, '').toLowerCase().trim().replace(/\s+/g, '-');
        }
        
        /**
         * Carrega os dados do Gist (URL RAW) para o ano especificado com retries (backoff).
         */
        async function loadDataFromGist(year, retries = 3, delay = 1000) {
            const url = GIST_URLS[year];
            
            if (!url || url.includes('placeholder')) {
                showFeedback(`URL do Gist para ${year} não configurada. Usando dados de exemplo (Fallback).`, 'bg-red-100 text-red-800');
                loadingIndicator.classList.add('hidden');
                filterArea.classList.remove('hidden');
                exportArea.classList.remove('hidden');
                processAndRenderData(fallbackScheduleData);
                return;
            }

            loadingIndicator.textContent = `A carregar horários para o ano ${year} (Tentativa 1/${retries})...`;
            turmaSelect.disabled = true;
            disciplinaSelect.disabled = true;
            exportPdfBtn.disabled = true;

            for (let i = 0; i < retries; i++) {
                try {
                    loadingIndicator.textContent = `A carregar horários para o ano ${year} (Tentativa ${i + 1}/${retries})...`;
                    
                    const response = await fetch(url);

                    if (!response.ok) {
                        // Se for um erro 404/403, não faz retry, apenas falha
                        if (response.status === 404 || response.status === 403) {
                             throw new Error(`Erro: O recurso na URL (${url}) retornou status ${response.status}. Verifique se o link está ativo e é a versão RAW.`);
                        }
                        // Para outros erros (ex: 500, network issues), continua o retry
                        throw new Error(`Erro de rede: Status ${response.status}.`);
                    }

                    const rawText = await response.text();
                    
                    let rawDataArray;
                    try {
                        rawDataArray = parseCSV(rawText);
                        if (rawDataArray.length === 0) {
                            throw new Error(`O arquivo CSV/TXT está vazio ou o formato/delimitador ("${CSV_DELIMITER}") está incorreto.`);
                        }
                    } catch (e) {
                        console.error("ERRO CRÍTICO: Falha ao analisar CSV.", e);
                        throw new Error("O Gist tem um formato CSV inválido ou não contém dados válidos.");
                    }

                    processAndRenderData(rawDataArray);
                    return; // Sucesso, sai da função
                    
                } catch (error) {
                    // Não loga erros no console durante o backoff para evitar poluição
                    // console.error(`Tentativa ${i + 1} falhou para carregar dados de ${year}: ${error.message}`); 
                    if (i === retries - 1) {
                        // Última tentativa falhou
                        throw error;
                    }
                    // Espera antes de tentar novamente
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }

            // Se o loop de retries falhar completamente
            console.error(`Todas as ${retries} tentativas falharam. Usando dados de fallback.`);
            showFeedback(`Erro crítico ao carregar a URL do Gist (${url}). Todas as tentativas falharam. Usando dados de exemplo (Fallback).`, 'bg-red-100 text-red-800');
            loadingIndicator.classList.add('hidden');
            filterArea.classList.remove('hidden');
            exportArea.classList.remove('hidden');
            processAndRenderData(fallbackScheduleData);
        }

        /**
         * Processa a lista de objetos (agora vindos do CSV) para a estrutura hierárquica 
         * Turma > Disciplina > Professor > Horário.
         */
        function processAndRenderData(dataArray) {
            const data = {};
            
            dataArray.forEach((item) => {
                // Mapeamento: A=Mês, B=Dia do Mês, C=Dia da Semana, D=Horário, E=Turma, F=Disciplina + Professor (UNIDOS)
                const turmaName = item.E?.toString().trim();
                const combinedDisciplineProfessor = item.F?.toString().trim(); 
                const month = item.A?.toString().trim();
                const dayOfMonth = item.B;
                const dayOfWeek = item.C?.toString().trim();
                const time = item.D?.toString().trim();

                // LÓGICA DE SEPARAÇÃO DA COLUNA F (Disciplina - Professor)
                let disciplineName = 'Disciplina Não Informada';
                let professorName = 'Professor(a) Desconhecido(a)';

                if (combinedDisciplineProfessor) {
                    const hyphenIndex = combinedDisciplineProfessor.indexOf('-');
                    
                    if (hyphenIndex !== -1) {
                        disciplineName = combinedDisciplineProfessor.substring(0, hyphenIndex).trim();
                        professorName = combinedDisciplineProfessor.substring(hyphenIndex + 1).trim();
                    } else {
                        disciplineName = combinedDisciplineProfessor;
                    }
                }
                
                // Verifica se os campos essenciais existem
                const parsedDayOfMonth = parseInt(dayOfMonth, 10);
                if (!turmaName || !disciplineName || !month || !dayOfWeek || !time || isNaN(parsedDayOfMonth)) {
                    return; 
                }
                
                const turmaId = generateId(turmaName);
                const disciplinaId = generateId(disciplineName);
                const professorId = generateId(professorName); // ID para o professor

                // 1. Inicializa a Turma
                if (!data[turmaId]) {
                    data[turmaId] = { name: turmaName, disciplines: {} };
                }

                // 2. Inicializa a Disciplina
                if (!data[turmaId].disciplines[disciplinaId]) {
                    data[turmaId].disciplines[disciplinaId] = {
                        name: disciplineName,
                        professors: {} // NOVA CAMADA: Agrupa por Professor
                    };
                }
                
                // 3. Inicializa o Professor
                const discipline = data[turmaId].disciplines[disciplinaId];
                if (!discipline.professors[professorId]) {
                    discipline.professors[professorId] = {
                        name: professorName,
                        schedule: [] // O Horário está agora aqui
                    };
                }

                // 4. Adiciona o horário (SEM O CAMPO 'professor' redundante)
                discipline.professors[professorId].schedule.push({
                    month: month,
                    dayOfMonth: parsedDayOfMonth,
                    dayOfWeek: dayOfWeek,
                    time: time
                });
            });

            processedData = data;
            
            populateTurmaSelect();
            
            loadingIndicator.classList.add('hidden');
            filterArea.classList.remove('hidden');
            exportArea.classList.remove('hidden');
            showFeedback('Dados processados com sucesso. Selecione uma Turma.', 'bg-green-100 text-green-800');
        }


        // =========================================================================
        // 4. FUNÇÕES DE LÓGICA (UI)
        // =========================================================================
        
        function initApp() {
            dataRelatorioSpan.textContent = new Date().toLocaleDateString('pt-BR');

            // 1. Adiciona listeners
            yearSelect.addEventListener('change', handleYearChange);
            turmaSelect.addEventListener('change', handleTurmaChange);
            disciplinaSelect.addEventListener('change', handleDisciplinaChange);
            // Listener de professor removido, pois a filtragem para na disciplina
            exportPdfBtn.addEventListener('click', exportReportToPdf);
            
            // 2. Preenche o seletor de ano
            populateYearSelect();
            
            // 3. Inicia o carregamento de dados para o ano padrão
            loadDataFromGist(currentYear);
        }
        
        function populateYearSelect() {
            const years = Object.keys(GIST_URLS).sort((a, b) => parseInt(a) - parseInt(b));
            yearSelect.innerHTML = '';
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
            
            yearSelect.value = DEFAULT_YEAR;
        }

        function handleYearChange(event) {
            const selectedYear = event.target.value;
            currentYear = selectedYear;
            
            // Limpa todas as seleções dependentes
            turmaSelect.innerHTML = '<option value="">-- Selecione a Turma --</option>';
            disciplinaSelect.innerHTML = '<option value="">-- Selecione uma Disciplina --</option>';
            renderTable([]);
            
            loadDataFromGist(selectedYear);
        }
        
        function populateTurmaSelect() {
            const currentTurmaValue = turmaSelect.value;
            
            // Limpa e desabilita os seletores dependentes
            disciplinaSelect.innerHTML = '<option value="">-- Selecione uma Disciplina --</option>';
            disciplinaSelect.disabled = true;
            disciplinaSelect.classList.add('bg-gray-100');
            // Seletor de professor foi removido

            exportPdfBtn.disabled = true;
            
            turmaSelect.innerHTML = '<option value="">-- Selecione a Turma --</option>';
            
            for (const key in processedData) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = processedData[key].name;
                turmaSelect.appendChild(option);
            }
            
            if (Object.keys(processedData).length > 0) {
                turmaSelect.disabled = false;
                turmaSelect.classList.remove('bg-gray-100');
            } else {
                turmaSelect.disabled = true;
                turmaSelect.classList.add('bg-gray-100');
                renderTable([]);
            }
            
            if (currentTurmaValue && processedData[currentTurmaValue]) {
                turmaSelect.value = currentTurmaValue;
                handleTurmaChange({ target: { value: currentTurmaValue } });
            }
        }

        /**
         * Lida com a mudança da Turma, populando as Disciplinas.
         */
        function handleTurmaChange(event) {
            const selectedTurma = event.target.value;
            
            disciplinaSelect.innerHTML = '<option value="">-- Selecione uma Disciplina --</option>';
            disciplinaSelect.disabled = true;
            disciplinaSelect.classList.add('bg-gray-100');
            
            renderTable([]);
            exportPdfBtn.disabled = true;

            if (selectedTurma && processedData[selectedTurma]) {
                const disciplines = processedData[selectedTurma].disciplines;
                
                // --- INÍCIO DA LÓGICA DE ORDENAÇÃO ALFABÉTICA ---

                // 1. Obtém as chaves (IDs) das disciplinas
                const disciplineKeys = Object.keys(disciplines);
                
                // 2. Ordena as chaves com base no nome da disciplina (case-insensitive)
                disciplineKeys.sort((keyA, keyB) => {
                    const nameA = disciplines[keyA].name.toUpperCase();
                    const nameB = disciplines[keyB].name.toUpperCase();
                    if (nameA < nameB) return -1;
                    if (nameA > nameB) return 1;
                    return 0;
                });
                
                // 3. Itera sobre as chaves ordenadas para criar as opções
                for (const key of disciplineKeys) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = disciplines[key].name;
                    disciplinaSelect.appendChild(option);
                }
                
                // --- FIM DA LÓGICA DE ORDENAÇÃO ALFABÉTICA ---
                
                disciplinaSelect.disabled = false;
                disciplinaSelect.classList.remove('bg-gray-100');
            }
        }

        /**
         * Lida com a mudança da Disciplina, agregando e exibindo os horários de todos os professores.
         */
        function handleDisciplinaChange(event) {
            const selectedTurma = turmaSelect.value;
            const selectedDiscipline = event.target.value;
            
            currentSchedule = [];
            exportPdfBtn.disabled = true;
            renderTable([]);

            if (selectedTurma && selectedDiscipline) {
                const disciplineData = processedData[selectedTurma].disciplines[selectedDiscipline];
                
                // 1. Itera sobre todos os professores desta disciplina
                for (const professorId in disciplineData.professors) {
                    const professor = disciplineData.professors[professorId];
                    
                    // 2. Para cada professor, anexa o nome dele a cada item de horário
                    const schedulesWithProfessor = professor.schedule.map(item => ({
                        ...item,
                        professorName: professor.name // Adiciona o nome do professor ao objeto de horário
                    }));
                    
                    // 3. Adiciona os horários processados ao agendamento principal
                    currentSchedule.push(...schedulesWithProfessor);
                }
                
                // Exibe a tabela com o horário agregado
                renderTable(currentSchedule);
                exportPdfBtn.disabled = currentSchedule.length === 0;
            }
        }
        
        // A função handleProfessorChange foi removida, pois a filtragem termina na disciplina.

        function renderTable(schedule) {
            tableBody.innerHTML = '';
            
            // O nome do professor é extraído de cada item do 'schedule'

            if (schedule && schedule.length > 0) {
                schedule.sort((a, b) => {
                    // Lógica de ordenação: por Mês e Dia do Mês
                    const monthOrder = {
                        "Janeiro": 1, "Fevereiro": 2, "Março": 3, "Abril": 4, 
                        "Maio": 5, "Junho": 6, "Julho": 7, "Agosto": 8, 
                        "Setembro": 9, "Outubro": 10, "Novembro": 11, "Dezembro": 12
                    };
                    const monthA = monthOrder[a.month] || 0;
                    const monthB = monthOrder[b.month] || 0;

                    if (monthA !== monthB) return monthA - monthB;
                    return a.dayOfMonth - b.dayOfMonth;
                });

                schedule.forEach((item, index) => {
                    const row = tableBody.insertRow();
                    row.classList.add('hover:bg-gray-50', index % 2 === 0 ? 'bg-white' : 'bg-gray-50');

                    row.insertCell().textContent = item.month;
                    row.insertCell().textContent = item.dayOfMonth;
                    row.insertCell().textContent = item.dayOfWeek;
                    row.insertCell().textContent = item.time;
                    // Usa o nome do professor armazenado no próprio item (adicionado em handleDisciplinaChange)
                    row.insertCell().textContent = item.professorName; 
                    
                    Array.from(row.cells).forEach(cell => {
                        cell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-900');
                    });
                });
                totalDiasSpan.textContent = schedule.length;
            } else {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 5; 
                cell.classList.add('px-6', 'py-4', 'text-center', 'text-sm', 'text-gray-500', 'italic');
                
                // Mensagem atualizada para o novo fluxo
                cell.textContent = 'Selecione a turma e a disciplina para ver os horários.';
                
                totalDiasSpan.textContent = 0;
            }
        }
        
        /**
         * Gera e descarrega o relatório de horários em formato PDF.
         */
        async function exportReportToPdf() {
            
            // Nova verificação
            if (!disciplinaSelect.value) {
                showFeedback('Selecione uma Turma e Disciplina antes de exportar.', 'bg-red-100 text-red-800');
                return;
            }

            exportPdfBtn.disabled = true;
            exportPdfBtn.textContent = 'Gerando PDF...';
            showFeedback('Gerando relatório PDF...', 'bg-yellow-100 text-yellow-800');

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            let y = margin;
            
            const selectedYearText = yearSelect.options[yearSelect.selectedIndex].text;
            const selectedTurmaText = turmaSelect.options[turmaSelect.selectedIndex].text;
            const selectedDisciplinaText = disciplinaSelect.options[disciplinaSelect.selectedIndex].text;
            const totalDiasText = totalDiasSpan.textContent;
            
            // Lista todos os professores envolvidos
            const professorNames = Array.from(new Set(currentSchedule.map(item => item.professorName))).join(' / ');


            const addCenteredText = (text, size, style = 'normal') => {
                doc.setFont('helvetica', style);
                doc.setFontSize(size);
                const textWidth = doc.getStringUnitWidth(text) * size / doc.internal.scaleFactor;
                const x = (pageWidth - textWidth) / 2;
                doc.text(text, x, y);
                y += size * 0.4;
            };

            y += 5;
            addCenteredText('INSTITUTO FEDERAL DE RONDÔNIA', 14, 'bold');
            addCenteredText('CAMPUS CACOAL', 12, 'italic');
            y += 5;
            addCenteredText('DEPARTAMENTO DE APOIO AO ENSINO', 10);
            addCenteredText('COORDENAÇÃO DE DESENVOLVIMENTO DE FERRAMENTAS PEDAGÓGICAS', 10);
            
            y += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(`Relatório de Horários de Aula (Disciplina Agregada) - Ano ${selectedYearText}`, margin, y);
            y += 5;
            doc.setFont('helvetica', 'normal');
            doc.text(`Turma: ${selectedTurmaText}`, margin, y);
            y += 5;
            doc.text(`Disciplina: ${selectedDisciplinaText}`, margin, y);
            y += 5;
            // Lista os professores envolvidos no cabeçalho
            doc.text(`Professores Envolvidos: ${professorNames}`, margin, y); 
            y += 5;
            doc.text(`Total de Dias de Aula (para a Disciplina): ${totalDiasText}`, margin, y);
            y += 10;
            
            // Cabeçalho da tabela do PDF
            const headers = [["Mês", "Dia do Mês", "Dia da Semana", "Horário da Aula", "Professor"]]; 
            
            // Dados da tabela do PDF: usa item.professorName
            const data = currentSchedule.map(item => [
                item.month, 
                item.dayOfMonth.toString(), 
                item.dayOfWeek, 
                item.time,
                item.professorName // Usa o nome do professor da linha específica
            ]);

            doc.autoTable({
                head: headers,
                body: data,
                startY: y,
                theme: 'striped',
                headStyles: { fillColor: [22, 163, 74], fontStyle: 'bold' },
                styles: { fontSize: 8, cellPadding: 2 },
                margin: { top: margin, bottom: margin, left: margin, right: margin },
                didDrawPage: function (data) {
                    const footerText = `${dataRelatorioSpan.textContent} / Campus Cacoal`;
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    const textWidth = doc.getStringUnitWidth(footerText) * 8 / doc.internal.scaleFactor;
                    const x = (pageWidth - textWidth) / 2;
                    doc.text(footerText, x, doc.internal.pageSize.getHeight() - 10);
                }
            });

            const fileName = `Relatorio_${selectedYearText}_${selectedTurmaText.replace(/\s/g, '_')}_${selectedDisciplinaText.replace(/\s/g, '_')}_Agregado.pdf`;
            doc.save(fileName);

            exportPdfBtn.disabled = false;
            exportPdfBtn.textContent = 'Exportar Relatório em PDF';
            showFeedback('Relatório PDF gerado com sucesso!', 'bg-green-100 text-green-800');
        }
        
        /**
         * Exibe uma mensagem de feedback temporária no UI.
         */
        function showFeedback(message, className) {
            feedbackMessage.classList.remove('hidden', 'bg-yellow-100', 'text-yellow-800', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
            feedbackMessage.classList.add(...className.split(' ')); 
            feedbackMessage.textContent = message;
            
            setTimeout(() => {
                feedbackMessage.classList.add('hidden');
            }, 5000); 
        }

        // Inicializa a aplicação ao carregar a página
        document.addEventListener('DOMContentLoaded', () => {
             // Carrega o plugin autoTable (necessário para o PDF)
            const autoTableScript = document.createElement('script');
            autoTableScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js';
            document.head.appendChild(autoTableScript);

            autoTableScript.onload = initApp;
        });

    </script>

</body>
</html>
