<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Horários - IFRO Campus Cacoal (Multianual)</title>
    <!-- Carrega o Tailwind CSS para o estilo responsivo e moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'ifro-primary': '#16A34A', 
                        'ifro-light': '#F3F4F6',
                    }
                }
            }
        }
    </script>
    <!-- Scripts para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="bg-ifro-light font-sans min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-xl container-shadow overflow-hidden">
        
        <!-- CABEÇALHO INSTITUCIONAL -->
        <header class="header-bg p-6 text-center rounded-t-xl">
            <h1 class="text-3xl font-extrabold mb-1">INSTITUTO FEDERAL DE RONDÔNIA</h1>
            <h2 class="text-2xl font-semibold italic mb-4">CAMPUS CACOAL</h2>
            <div class="h-0.5 bg-white opacity-20 mx-auto w-3/4 mb-4"></div>
            <p class="text-sm font-light mb-1">DEPARTAMENTO DE APOIO AO ENSINO</p>
            <p class="text-sm font-medium">COORDENAÇÃO DE DESENVOLVIMENTO DE FERRAMENTAS PEDAGÓGICAS</p>
        </header>

        <!-- CORPO DA CONSULTA -->
        <main class="p-6 md:p-8">
            <h3 class="text-xl font-bold text-gray-800 mb-6 border-b pb-2">Consulta de Horários por Ano, Turma e Disciplina</h3>
            
            <!-- INDICADOR DE CARREGAMENTO -->
            <div id="loadingIndicator" class="text-center p-4 bg-ifro-light rounded-lg font-bold text-ifro-primary">
                A carregar dados iniciais...
            </div>

            <!-- ÁREA DE FILTROS -->
            <div id="filterArea" class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8 hidden">
                
                <!-- 1. SELETOR DE ANO -->
                <div>
                    <label for="yearSelect" class="block text-sm font-bold text-gray-700 mb-1">ANO LETIVO</label>
                    <select id="yearSelect" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-ifro-primary focus:border-ifro-primary transition duration-150 ease-in-out">
                        <!-- Opções preenchidas via JavaScript -->
                    </select>
                </div>

                <!-- 2. SELETOR DE TURMA -->
                <div>
                    <label for="turmaSelect" class="block text-sm font-bold text-gray-700 mb-1">TURMA</label>
                    <select id="turmaSelect" disabled class="w-full p-3 border border-gray-300 bg-gray-100 rounded-lg shadow-sm focus:ring-ifro-primary focus:border-ifro-primary transition duration-150 ease-in-out">
                        <option value="">-- Selecione a Turma --</option>
                    </select>
                </div>

                <!-- 3. SELETOR DE DISCIPLINA -->
                <div>
                    <label for="disciplinaSelect" class="block text-sm font-bold text-gray-700 mb-1">DISCIPLINA</label>
                    <select id="disciplinaSelect" disabled class="w-full p-3 border border-gray-300 bg-gray-100 rounded-lg shadow-sm focus:ring-ifro-primary focus:border-ifro-primary transition duration-150 ease-in-out">
                        <option value="">-- Selecione uma Disciplina --</option>
                    </select>
                </div>
            </div>

            <!-- BOTÃO DE EXPORTAÇÃO E SUMÁRIO DE DIAS -->
            <div id="exportArea" class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8 p-4 bg-ifro-light rounded-lg border border-gray-200 hidden">
                <button id="exportPdfBtn" disabled class="w-full sm:w-auto px-6 py-3 text-lg font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 transition duration-150 ease-in-out shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                    Exportar Relatório em PDF
                </button>
                <div class="text-gray-700 text-base font-semibold">
                    Total de Dias de Aula da Disciplina: <span id="totalDias" class="text-xl text-ifro-primary font-extrabold">0</span>
                </div>
            </div>

            <!-- TABELA DE RESULTADOS -->
            <div id="tableContainer" class="overflow-x-auto border border-gray-300 rounded-lg shadow-lg">
                <table id="horariosTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Mês</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Dia do Mês</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Dia da Semana</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Horário da Aula</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Professor</th> <!-- Coluna de Professor separada no relatório -->
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500 italic">Aguardando dados...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Mensagem de feedback -->
            <div id="feedbackMessage" class="hidden mt-4 p-3 rounded-lg text-center font-medium"></div>
        </main>

        <!-- RODAPÉ -->
        <footer class="p-4 bg-gray-100 text-center text-xs text-gray-600 border-t rounded-b-xl">
            <span id="dataRelatorio"></span> / Campus Cacoal
        </footer>

    </div>

    <script type="module">
        
        // =========================================================================
        // 1. CONFIGURAÇÃO DA FONTE DE DADOS (GIST) - **ATUALIZAR AQUI**
        // -------------------------------------------------------------------------
        // A estrutura JSON esperada é: 
        // A=Mês, B=Dia do Mês, C=Dia da Semana, D=Horário, E=Turma, 
        // F=Disciplina e Professor (Ex: "Programação Web I - Prof. Jamil Salim")
        // O código irá separar a disciplina do professor para o relatório.
        // =========================================================================
        
        // Mapeamento dos anos para as URLs RAW (brutas) dos Gists
        const GIST_URLS = {
            '2025': 'https://placeholder.com/2025_gist_url', // <-- SUBSTITUA ESTE URL
            '2026': 'https://gist.githubusercontent.com/jamilsalim-afk/9190f1ffef7618a7ccd8d2b82adb6b9e/raw/8c9680d8a4a623e634998f8a539f7e5ad9b3129a/gistfile1.csv',
            '2027': 'https://placeholder.com/2027_gist_url', // <-- SUBSTITUA ESTE URL
            '2028': 'https://placeholder.com/2028_gist_url', // <-- SUBSTITUA ESTE URL
            '2029': 'https://placeholder.com/2029_gist_url', // <-- SUBSTITUA ESTE URL
            '2030': 'https://placeholder.com/2030_gist_url'  // <-- SUBSTITUA ESTE URL
        };
        
        // Define o ano padrão para carregar no início
        const DEFAULT_YEAR = '2026';

        // Dados estáticos de fallback (agora com F contendo Disciplina - Professor)
        const fallbackScheduleData = [
            {A: "Setembro", B: "5", C: "Terça-feira", D: "19:00 - 20:40", E: "TADS - 2023", F: "Programação Web I - Prof. Jamil Salim"},
            {A: "Setembro", B: "7", C: "Quinta-feira", D: "20:50 - 22:30", E: "TADS - 2023", F: "Banco de Dados I - Prof. Ana Paula"},
            {A: "Agosto", B: "10", C: "Segunda-feira", D: "07:30 - 09:10", E: "Agropecuária Integrado - 2024", F: "Matemática I - Prof. Carlos Souza"}
        ];

        // =========================================================================
        // 2. VARIÁVEIS DE ESTADO E REFERÊNCIAS DOM
        // =========================================================================
        
        let processedData = {};
        let currentSchedule = [];
        let currentYear = DEFAULT_YEAR; 
        
        // Referências aos elementos do DOM
        const yearSelect = document.getElementById('yearSelect'); 
        const turmaSelect = document.getElementById('turmaSelect');
        const disciplinaSelect = document.getElementById('disciplinaSelect');
        const tableBody = document.getElementById('tableBody');
        const totalDiasSpan = document.getElementById('totalDias');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const dataRelatorioSpan = document.getElementById('dataRelatorio');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const filterArea = document.getElementById('filterArea');
        const exportArea = document.getElementById('exportArea');
        
        // =========================================================================
        // 3. FUNÇÕES UTILITÁRIAS E CARREGAMENTO DE DADOS
        // =========================================================================

        /**
         * Gera um ID seguro para uso como chave.
         */
        function generateId(name) {
            return name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9\s-]/g, '').toLowerCase().trim().replace(/\s+/g, '-');
        }
        
        /**
         * Carrega os dados do Gist (URL RAW) para o ano especificado.
         * @param {string} year - O ano para o qual carregar os dados.
         */
        async function loadDataFromGist(year) {
            const url = GIST_URLS[year];
            if (!url || url.includes('placeholder')) {
                showFeedback(`URL do Gist para ${year} não configurada. Usando dados de exemplo.`, 'bg-red-100 text-red-800');
                processAndRenderData(fallbackScheduleData);
                return;
            }

            loadingIndicator.textContent = `A carregar horários para o ano ${year}...`;
            turmaSelect.disabled = true;
            disciplinaSelect.disabled = true;
            exportPdfBtn.disabled = true;
            
            try {
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`Erro de rede ao carregar o Gist para ${year}. Status: ${response.statusText}`);
                }

                const rawText = await response.text();
                
                let rawDataArray;
                try {
                    // Tenta analisar o texto bruto como JSON
                    rawDataArray = JSON.parse(rawText);
                    if (!Array.isArray(rawDataArray)) {
                        throw new Error("O Gist não contém uma array JSON válida.");
                    }
                } catch (e) {
                    console.error("ERRO CRÍTICO: Falha ao analisar JSON.", e);
                    throw new Error("O Gist tem um formato JSON inválido. Não é possível ler os dados.");
                }

                console.log(`DEBUG: Total de ${rawDataArray.length} objetos JSON lidos para ${year}.`);
                processAndRenderData(rawDataArray);

            } catch (error) {
                console.error(`ERRO CRÍTICO: Erro ao carregar dados do Gist para ${year}. Usando dados de fallback.`, error);
                showFeedback(`Erro ao carregar Gist para ${year}. Usando dados de exemplo.`, 'bg-red-100 text-red-800');
                // Usa dados de fallback em caso de falha
                processAndRenderData(fallbackScheduleData);
            }
        }
        
        /**
         * Processa a lista de objetos JSON para a estrutura hierárquica Turma > Disciplina > Horário.
         * Extrai o nome do professor da coluna F.
         */
        function processAndRenderData(dataArray) {
            const data = {};
            
            // Lógica para pular a linha de cabeçalho JSON (se existir)
            let processedItems = [...dataArray];
            if (processedItems.length > 0 && processedItems[0].A === 'mês' && processedItems[0].F === 'disciplina') {
                processedItems.shift(); 
            }

            processedItems.forEach((item, index) => {
                // Mapeamento de JSON: A=Mês, B=Dia do Mês, C=Dia da Semana, D=Horário, E=Turma, F=Disciplina e Professor
                const turmaName = item.E?.toString().trim();
                const fullDisciplineString = item.F?.toString().trim();
                const month = item.A?.toString().trim();
                const dayOfMonth = item.B;
                const dayOfWeek = item.C?.toString().trim();
                const time = item.D?.toString().trim();

                // --- NOVA LÓGICA DE EXTRAÇÃO ---
                let disciplineName = fullDisciplineString;
                let professorName = "Não Informado";
                
                // Tenta separar a Disciplina do Professor usando " - " como delimitador comum
                const parts = fullDisciplineString.split(' - ').map(p => p.trim()).filter(p => p.length > 0);
                
                if (parts.length >= 2) {
                    // Assume que a disciplina é o primeiro elemento e o professor é o último
                    disciplineName = parts[0]; 
                    professorName = parts[parts.length - 1]; // Pega o último pedaço como Professor
                } else {
                    // Se não houver o delimitador, usa o nome completo como disciplina e sinaliza a ausência do professor
                    disciplineName = fullDisciplineString;
                    professorName = "Não Informado (Formato Inválido)";
                }

                // Verifica se os campos essenciais existem
                if (!turmaName || !disciplineName || !month || !dayOfWeek || !time || isNaN(parseInt(dayOfMonth, 10))) {
                    console.warn(`DEBUG WARNING: Objeto JSON incompleto ou inválido na Posição ${index + 1}. Item (F: ${fullDisciplineString}):`, item);
                    return; 
                }
                
                const turmaId = generateId(turmaName);
                const disciplinaId = generateId(disciplineName); // ID baseado no nome da disciplina extraído

                // 1. Inicializa a Turma se não existir
                if (!data[turmaId]) {
                    data[turmaId] = {
                        name: turmaName,
                        disciplines: {}
                    };
                }

                // 2. Inicializa a Disciplina se não existir
                if (!data[turmaId].disciplines[disciplinaId]) {
                    data[turmaId].disciplines[disciplinaId] = {
                        name: disciplineName, // Usa o nome puro da disciplina para o filtro
                        schedule: []
                    };
                }

                // 3. Adiciona o horário
                data[turmaId].disciplines[disciplinaId].schedule.push({
                    month: month,
                    dayOfMonth: parseInt(dayOfMonth, 10),
                    dayOfWeek: dayOfWeek,
                    time: time,
                    professor: professorName // Armazena o professor extraído
                });
            });

            processedData = data;
            
            // Re-renderiza a UI
            populateTurmaSelect();
            
            // Esconde o indicador de carregamento e mostra os filtros
            loadingIndicator.classList.add('hidden');
            filterArea.classList.remove('hidden');
            exportArea.classList.remove('hidden');
        }


        // =========================================================================
        // 4. FUNÇÕES DE LÓGICA (UI)
        // =========================================================================
        
        function initApp() {
            // Preenche o rodapé com a data atual
            dataRelatorioSpan.textContent = new Date().toLocaleDateString('pt-BR');

            // 1. Adiciona listeners
            yearSelect.addEventListener('change', handleYearChange);
            turmaSelect.addEventListener('change', handleTurmaChange);
            disciplinaSelect.addEventListener('change', handleDisciplinaChange);
            exportPdfBtn.addEventListener('click', exportReportToPdf);
            
            // 2. Preenche o seletor de ano
            populateYearSelect();
            
            // 3. Inicia o carregamento de dados para o ano padrão
            loadDataFromGist(currentYear);
        }
        
        function populateYearSelect() {
            const years = Object.keys(GIST_URLS).sort((a, b) => parseInt(a) - parseInt(b));
            yearSelect.innerHTML = '';
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
            
            // Define o ano padrão
            yearSelect.value = DEFAULT_YEAR;
        }

        function handleYearChange(event) {
            const selectedYear = event.target.value;
            currentYear = selectedYear;
            
            // Limpa as seleções dependentes e a tabela
            turmaSelect.innerHTML = '<option value="">-- Selecione a Turma --</option>';
            disciplinaSelect.innerHTML = '<option value="">-- Selecione uma Disciplina --</option>';
            renderTable([]);
            
            // Dispara o carregamento do novo Gist
            loadDataFromGist(selectedYear);
        }
        
        function populateTurmaSelect() {
            const currentTurmaValue = turmaSelect.value;
            
            // Limpa e desabilita o botão
            disciplinaSelect.innerHTML = '<option value="">-- Selecione uma Disciplina --</option>';
            disciplinaSelect.disabled = true;
            disciplinaSelect.classList.add('bg-gray-100');
            exportPdfBtn.disabled = true;
            
            // Limpa as opções atuais do select de turmas (exceto a primeira)
            turmaSelect.innerHTML = '<option value="">-- Selecione a Turma --</option>';
            
            // Preenche o dropdown de Turmas
            for (const key in processedData) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = processedData[key].name;
                turmaSelect.appendChild(option);
            }
            
            // Habilita o select de turmas se houver dados
            if (Object.keys(processedData).length > 0) {
                turmaSelect.disabled = false;
                turmaSelect.classList.remove('bg-gray-100');
            } else {
                turmaSelect.disabled = true;
                turmaSelect.classList.add('bg-gray-100');
                renderTable([]);
            }
            
            // Tenta restaurar a seleção (se os dados para o novo ano tiverem a mesma turma)
            if (currentTurmaValue && processedData[currentTurmaValue]) {
                turmaSelect.value = currentTurmaValue;
                handleTurmaChange({ target: { value: currentTurmaValue } });
            }
        }

        function handleTurmaChange(event) {
            const selectedTurma = event.target.value;
            
            disciplinaSelect.innerHTML = '<option value="">-- Selecione uma Disciplina --</option>';
            disciplinaSelect.disabled = true;
            disciplinaSelect.classList.add('bg-gray-100');
            
            renderTable([]);
            exportPdfBtn.disabled = true;

            if (selectedTurma && processedData[selectedTurma]) {
                const disciplines = processedData[selectedTurma].disciplines;
                
                for (const key in disciplines) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = disciplines[key].name; // Usa o nome puro da disciplina
                    disciplinaSelect.appendChild(option);
                }
                
                disciplinaSelect.disabled = false;
                disciplinaSelect.classList.remove('bg-gray-100');
            }
        }

        function handleDisciplinaChange(event) {
            const selectedTurma = turmaSelect.value;
            const selectedDiscipline = event.target.value;
            
            currentSchedule = [];
            exportPdfBtn.disabled = true;

            if (selectedTurma && selectedDiscipline) {
                const schedule = processedData[selectedTurma].disciplines[selectedDiscipline].schedule;
                currentSchedule = schedule;
                renderTable(schedule);
                exportPdfBtn.disabled = schedule.length === 0;
            } else {
                renderTable([]);
            }
        }

        function renderTable(schedule) {
            tableBody.innerHTML = '';
            
            if (schedule && schedule.length > 0) {
                schedule.forEach((item, index) => {
                    const row = tableBody.insertRow();
                    row.classList.add('hover:bg-gray-50', index % 2 === 0 ? 'bg-white' : 'bg-gray-50');

                    row.insertCell().textContent = item.month;
                    row.insertCell().textContent = item.dayOfMonth;
                    row.insertCell().textContent = item.dayOfWeek;
                    row.insertCell().textContent = item.time;
                    row.insertCell().textContent = item.professor; // Usa o Professor extraído
                    
                    Array.from(row.cells).forEach(cell => {
                        cell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-900');
                    });
                });
                totalDiasSpan.textContent = schedule.length;
            } else {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 5; 
                cell.classList.add('px-6', 'py-4', 'text-center', 'text-sm', 'text-gray-500', 'italic');
                
                cell.textContent = turmaSelect.value 
                    ? 'Nenhum horário encontrado para a disciplina selecionada.' 
                    : 'Selecione a turma e a disciplina.';
                
                totalDiasSpan.textContent = 0;
            }
        }
        
        /**
         * Gera e descarrega o relatório de horários em formato PDF.
         */
        async function exportReportToPdf() {
            
            if (!disciplinaSelect.value) {
                showFeedback('Selecione uma Turma e uma Disciplina antes de exportar.', 'bg-red-100 text-red-800');
                return;
            }

            exportPdfBtn.disabled = true;
            exportPdfBtn.textContent = 'Gerando PDF...';
            showFeedback('Gerando relatório PDF...', 'bg-yellow-100 text-yellow-800');

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            let y = margin;
            
            const selectedYearText = yearSelect.options[yearSelect.selectedIndex].text;
            const selectedTurmaText = turmaSelect.options[turmaSelect.selectedIndex].text;
            const selectedDisciplinaText = disciplinaSelect.options[disciplinaSelect.selectedIndex].text;
            const totalDiasText = totalDiasSpan.textContent;
            
            // Tenta obter o nome do professor principal (do primeiro registro, pois a disciplina é única)
            const professorPrincipal = currentSchedule.length > 0 ? currentSchedule[0].professor : 'N/A';


            const addCenteredText = (text, size, style = 'normal') => {
                doc.setFont('helvetica', style);
                doc.setFontSize(size);
                const textWidth = doc.getStringUnitWidth(text) * size / doc.internal.scaleFactor;
                const x = (pageWidth - textWidth) / 2;
                doc.text(text, x, y);
                y += size * 0.4;
            };

            y += 5;
            addCenteredText('INSTITUTO FEDERAL DE RONDÔNIA', 14, 'bold');
            addCenteredText('CAMPUS CACOAL', 12, 'italic');
            y += 5;
            addCenteredText('DEPARTAMENTO DE APOIO AO ENSINO', 10);
            addCenteredText('COORDENAÇÃO DE DESENVOLVIMENTO DE FERRAMENTAS PEDAGÓGICAS', 10);
            
            y += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(`Relatório de Horários de Aula - Ano ${selectedYearText}`, margin, y);
            y += 5;
            doc.setFont('helvetica', 'normal');
            doc.text(`Turma: ${selectedTurmaText}`, margin, y);
            y += 5;
            doc.text(`Disciplina: ${selectedDisciplinaText}`, margin, y);
            y += 5;
            doc.text(`Professor: ${professorPrincipal}`, margin, y); // Inclui o professor no cabeçalho do relatório
            y += 5;
            doc.text(`Total de Dias de Aula: ${totalDiasText}`, margin, y);
            y += 10;
            
            // Cabeçalho da tabela do PDF (sem a coluna de disciplina, pois é a mesma para todas as linhas)
            const headers = [["Mês", "Dia do Mês", "Dia da Semana", "Horário da Aula", "Professor"]]; 
            
            // Dados da tabela do PDF
            const data = currentSchedule.map(item => [
                item.month, 
                item.dayOfMonth.toString(), 
                item.dayOfWeek, 
                item.time,
                item.professor // Usa o Professor extraído
            ]);

            doc.autoTable({
                head: headers,
                body: data,
                startY: y,
                theme: 'striped',
                headStyles: { fillColor: [22, 163, 74], fontStyle: 'bold' },
                styles: { fontSize: 8, cellPadding: 2 },
                margin: { top: margin, bottom: margin, left: margin, right: margin },
                didDrawPage: function (data) {
                    const footerText = `${dataRelatorioSpan.textContent} / Campus Cacoal`;
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    const textWidth = doc.getStringUnitWidth(footerText) * 8 / doc.internal.scaleFactor;
                    const x = (pageWidth - textWidth) / 2;
                    doc.text(footerText, x, doc.internal.pageSize.getHeight() - 10);
                }
            });

            const fileName = `Relatorio_${selectedYearText}_${selectedTurmaText.replace(/\s/g, '_')}_${selectedDisciplinaText.replace(/\s/g, '_')}.pdf`;
            doc.save(fileName);

            exportPdfBtn.disabled = false;
            exportPdfBtn.textContent = 'Exportar Relatório em PDF';
            showFeedback('Relatório PDF gerado com sucesso!', 'bg-green-100 text-green-800');
        }
        
        /**
         * Exibe uma mensagem de feedback temporária no UI.
         */
        function showFeedback(message, className) {
            feedbackMessage.classList.remove('hidden', 'bg-yellow-100', 'text-yellow-800', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
            feedbackMessage.classList.add(...className.split(' ')); 
            feedbackMessage.textContent = message;
            
            setTimeout(() => {
                feedbackMessage.classList.add('hidden');
            }, 3000);
        }

        // Inicializa a aplicação ao carregar a página
        document.addEventListener('DOMContentLoaded', () => {
             // Carrega o plugin autoTable (necessário para o PDF)
            const autoTableScript = document.createElement('script');
            autoTableScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js';
            document.head.appendChild(autoTableScript);

            autoTableScript.onload = initApp;
        });

    </script>

</body>
</html>
