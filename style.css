<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão de Horários - IFRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        .tab-btn.active { border-bottom: 4px solid #15803d; color: #15803d; font-weight: 800; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <header class="bg-[#15803d] text-white shadow-lg no-print">
        <div class="container mx-auto px-6 py-8">
            <div class="flex flex-col md:flex-row justify-between items-center border-b border-green-600 pb-6">
                <div class="text-center md:text-left">
                    <h1 class="text-3xl font-black italic">INSTITUTO FEDERAL DE RONDÔNIA</h1>
                    <h2 class="text-xl font-bold opacity-90">CAMPUS CACOAL</h2>
                </div>
                <div class="mt-4 md:mt-0 bg-white/10 p-4 rounded-lg border border-white/20 text-center">
                    <p class="text-xs uppercase font-bold opacity-80">Data do Relatório</p>
                    <span id="dataRelatorio" class="text-lg font-mono">--/--/----</span>
                </div>
            </div>
            <div class="mt-4 flex flex-col md:flex-row justify-between items-center text-sm font-medium opacity-80">
                <p>DEPARTAMENTO DE APOIO AO ENSINO - DAE</p>
                <p>COORDENAÇÃO DE DESENVOLVIMENTO DE FERRAMENTAS PEDAGÓGICAS</p>
            </div>
        </div>
    </header>

    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex">
            <button class="tab-btn px-8 py-5 active" data-tab="tab-disciplina">POR DISCIPLINA</button>
            <button class="tab-btn px-8 py-5" data-tab="tab-pivo">RELATÓRIO PIVÔ</button>
            <button class="tab-btn px-8 py-5" data-tab="tab-semanal">GRADE SEMANAL</button>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-8">
        
        <section id="tab-disciplina" class="tab-pane active">
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <select id="yearSelect" class="p-3 border rounded-xl bg-gray-50"></select>
                    <select id="turmaSelect" class="p-3 border rounded-xl bg-gray-50" disabled><option>Selecione a Turma</option></select>
                    <select id="disciplinaSelect" class="p-3 border rounded-xl bg-gray-50" disabled><option>Selecione a Disciplina</option></select>
                </div>

                <div id="exportAreaDisciplina" class="hidden">
                    <div class="flex justify-between items-center mb-4 bg-green-50 p-4 rounded-lg">
                        <span class="font-bold">Total de Dias (Sem REC): <b id="totalDiasDisciplina" class="text-green-700 text-xl">0</b></span>
                        <button id="exportDisciplinaPdfBtn" class="bg-green-700 text-white px-6 py-2 rounded-lg font-bold">PDF DISCIPLINA</button>
                    </div>
                    <table id="horariosTableDisciplina" class="min-w-full bg-white border">
                        <thead class="bg-gray-800 text-white text-xs uppercase">
                            <tr><th class="p-3 text-left">Mês</th><th class="p-3 text-left">Dia</th><th class="p-3 text-left">Semana</th><th class="p-3 text-left">Horário</th><th class="p-3 text-left">Professor</th></tr>
                        </thead>
                        <tbody id="tableBodyDisciplina" class="text-sm"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="tab-pivo" class="tab-pane">
            <div class="bg-white p-6 rounded-xl shadow-md border">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <select id="yearSelectProfessor" class="p-3 border rounded-xl"></select>
                    <select id="turmaSelectProfessor" class="p-3 border rounded-xl">
                        <option value="">-- Selecione a Turma --</option>
                    </select>
                </div>
                <div class="flex justify-end mb-4">
                    <button id="exportProfessorPdfBtn" class="bg-green-700 text-white px-6 py-2 rounded-lg font-bold">EXPORTAR PIVÔ PDF</button>
                </div>
                <div class="overflow-x-auto">
                    <table id="tableProfessorPivot" class="min-w-full border text-xs">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="p-2 text-left">Disciplina</th>
                                <th>Jan</th><th>Fev</th><th>Mar</th><th>Abr</th><th>Mai</th><th>Jun</th><th>Jul</th><th>Ago</th><th>Set</th><th>Out</th><th>Nov</th><th>Dez</th>
                            </tr>
                        </thead>
                        <tbody id="tableBodyProfessorPivot"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="tab-semanal" class="tab-pane">
            <div class="bg-white p-6 rounded-xl shadow-md border">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <select id="selectProfSemanal" class="p-3 border rounded-xl"></select>
                    <input type="week" id="inputSemana" class="p-3 border rounded-xl">
                    <div class="flex gap-2">
                        <button onclick="gerarGradeSemanal()" class="bg-blue-600 text-white font-bold px-4 rounded-lg">VER</button>
                        <button onclick="exportarGradeSemanalPDF()" class="bg-green-700 text-white font-bold px-4 rounded-lg text-sm">PDF GRADE</button>
                    </div>
                </div>
                <div id="gradeSemanalResult"></div>
            </div>
        </section>
    </main>

    <script>
        // --- CONFIGURAÇÃO GLOBAL ---
        const GIST_URLS = { '2025': 'https://gist.githubusercontent.com/jamilsalim-afk/b8ff629ba4181ff68b988910e43fcefc/raw/799bb00af8e38569af8969c933df570f970858d7/2025.csv' };
        const monthOrder = { "janeiro": 1, "fevereiro": 2, "março": 3, "abril": 4, "maio": 5, "junho": 6, "julho": 7, "agosto": 8, "setembro": 9, "outubro": 10, "novembro": 11, "dezembro": 12 };
        const MONTH_MAP_PIVOT = { "janeiro": "Jan", "fevereiro": "Fev", "março": "Mar", "abril": "Abr", "maio": "Mai", "junho": "Jun", "julho": "Jul", "agosto": "Ago", "setembro": "Set", "outubro": "Out", "novembro": "Nov", "dezembro": "Dez" };
        
        let processedData = {};

        // --- INICIALIZAÇÃO ---
        window.onload = () => {
            document.getElementById('dataRelatorio').textContent = new Date().toLocaleDateString('pt-BR');
            initTabs();
            populateYears();
            loadGist('2025');
        };

        function initTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.tab-btn, .tab-pane').forEach(el => el.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.tab).classList.add('active');
                };
            });
        }

        function populateYears() {
            const selects = [document.getElementById('yearSelect'), document.getElementById('yearSelectProfessor')];
            selects.forEach(s => {
                Object.keys(GIST_URLS).forEach(y => s.innerHTML += `<option value="${y}">${y}</option>`);
            });
        }

        async function loadGist(year) {
            const res = await fetch(GIST_URLS[year]);
            const csv = await res.text();
            processData(csv);
        }

        function processData(csv) {
            processedData = {};
            const lines = csv.split(/\r?\n/).slice(1);
            lines.forEach(line => {
                const cols = line.split(';').map(c => c?.trim().replace(/^"|"$/g, ''));
                if (cols.length < 6) return;
                const [mes, dia, sem, hora, turma, discProf] = cols;
                const tId = turma.toLowerCase().replace(/[^a-z0-9]/g, '');
                
                if (!processedData[tId]) {
                    processedData[tId] = { 
                        name: turma, 
                        isSuperior: (turma.toUpperCase().includes('TADS') || turma.toUpperCase().includes('SUPERIOR') || turma.toUpperCase().includes('LICENCIATURA')),
                        disciplines: {} 
                    };
                }

                const [disc, prof] = discProf.includes('-') ? discProf.split('-').map(s => s.trim()) : [discProf, 'Não Informado'];
                const dId = disc.toLowerCase().replace(/[^a-z0-9]/g, '');

                if (!processedData[tId].disciplines[dId]) {
                    processedData[tId].disciplines[dId] = { name: disc, professors: {} };
                }

                const pId = prof.toLowerCase().replace(/[^a-z0-9]/g, '');
                if (!processedData[tId].disciplines[dId].professors[pId]) {
                    processedData[tId].disciplines[dId].professors[pId] = { name: prof, schedule: [] };
                }

                processedData[tId].disciplines[dId].professors[pId].schedule.push({
                    month: mes, day: dia, weekday: sem, time: hora,
                    isRec: prof.toUpperCase().includes('(REC)') || prof.toUpperCase().includes('(EXAME)')
                });
            });
            updateTurmaSelects();
        }

        function updateTurmaSelects() {
            const selects = [document.getElementById('turmaSelect'), document.getElementById('turmaSelectProfessor')];
            selects.forEach(s => {
                s.innerHTML = '<option value="">-- Selecione a Turma --</option>';
                Object.keys(processedData).sort((a,b) => processedData[a].name.localeCompare(processedData[b].name)).forEach(id => {
                    s.innerHTML += `<option value="${id}">${processedData[id].name}</option>`;
                });
                s.disabled = false;
            });
            populateProfessoresGrade();
        }

        // --- ABA 1 LÓGICA (CORREÇÃO ANUAL/SEMESTRAL) ---
        document.getElementById('turmaSelect').onchange = (e) => {
            const dSel = document.getElementById('disciplinaSelect');
            dSel.innerHTML = '<option>Selecione a Disciplina</option>';
            const tId = e.target.value;
            if (processedData[tId]) {
                Object.keys(processedData[tId].disciplines).sort().forEach(id => {
                    dSel.innerHTML += `<option value="${id}">${processedData[tId].disciplines[id].name}</option>`;
                });
                dSel.disabled = false;
            }
        };

        document.getElementById('disciplinaSelect').onchange = function() {
            const tId = document.getElementById('turmaSelect').value;
            const dId = this.value;
            const tbody = document.getElementById('tableBodyDisciplina');
            tbody.innerHTML = '';

            const turma = processedData[tId];
            const disc = turma.disciplines[dId];
            const mesAtual = new Date().getMonth();
            const semestreAtivo = (mesAtual <= 6) ? 1 : 2;

            let aulas = [];
            for (let pId in disc.professors) {
                disc.professors[pId].schedule.forEach(a => {
                    const mIdx = monthOrder[a.month.toLowerCase()];
                    const semAula = (mIdx <= 7) ? 1 : 2;
                    // Se for superior, filtra. Se for médio (anual), mostra tudo.
                    if (!turma.isSuperior || (turma.isSuperior && semAula === semestreAtivo)) {
                        aulas.push({ ...a, profName: disc.professors[pId].name });
                    }
                });
            }

            aulas.sort((a,b) => (monthOrder[a.month.toLowerCase()] - monthOrder[b.month.toLowerCase()]) || (a.day - b.day));
            aulas.forEach(a => {
                const row = tbody.insertRow();
                if (a.isRec) row.className = "bg-yellow-100 italic";
                row.innerHTML = `<td class="p-2 border-b">${a.month}</td><td class="p-2 border-b">${a.day}</td><td class="p-2 border-b">${a.weekday}</td><td class="p-2 border-b">${a.time}</td><td class="p-2 border-b font-bold">${a.profName}</td>`;
            });
            document.getElementById('totalDiasDisciplina').textContent = aulas.filter(x => !x.isRec).length;
            document.getElementById('exportAreaDisciplina').classList.remove('hidden');
        };

        // --- ABA 2 LÓGICA (CORREÇÃO PDF PIVÔ) ---
        document.getElementById('turmaSelectProfessor').onchange = populateTurmaProfessorSelect;

        function populateTurmaProfessorSelect() {
            const tId = document.getElementById('turmaSelectProfessor').value;
            const tbody = document.getElementById('tableBodyProfessorPivot');
            tbody.innerHTML = '';
            if (!processedData[tId]) return;

            const discData = processedData[tId].disciplines;
            Object.keys(discData).sort().forEach(dId => {
                const row = tbody.insertRow();
                let html = `<td class="p-2 border-b font-bold">${discData[dId].name}</td>`;
                let counts = {};
                Object.values(MONTH_MAP_PIVOT).forEach(m => counts[m] = 0);

                for (let pId in discData[dId].professors) {
                    discData[dId].professors[pId].schedule.forEach(a => {
                        if (a.isRec) return;
                        const mLabel = MONTH_MAP_PIVOT[a.month.toLowerCase()];
                        if (mLabel) counts[mLabel]++;
                    });
                }
                Object.values(MONTH_MAP_PIVOT).forEach(m => html += `<td class="p-2 border-b text-center">${counts[m] || '-'}</td>`);
                row.innerHTML = html;
            });
        }

        // --- EXPORTAÇÃO PDF PIVÔ (TURMA) ---
        document.getElementById('exportProfessorPdfBtn').onclick = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            const tText = document.getElementById('turmaSelectProfessor').options[document.getElementById('turmaSelectProfessor').selectedIndex].text;
            
            doc.setFontSize(16); doc.text("IFRO - CAMPUS CACOAL", 148, 15, {align: 'center'});
            doc.setFontSize(12); doc.text(`RELATÓRIO DE CARGA MENSAL - TURMA: ${tText}`, 148, 22, {align: 'center'});
            
            doc.autoTable({
                html: '#tableProfessorPivot',
                startY: 30,
                theme: 'grid',
                styles: { fontSize: 8, halign: 'center' },
                headStyles: { fillColor: [21, 128, 61] },
                columnStyles: { 0: { halign: 'left', fontStyle: 'bold', cellWidth: 60 } }
            });
            doc.save(`Carga_Mensal_${tText}.pdf`);
        };

        // --- ABA 3 LÓGICA (GRADE SEMANAL) ---
        function populateProfessoresGrade() {
            const sel = document.getElementById('selectProfSemanal');
            const profs = new Set();
            for(let t in processedData) 
                for(let d in processedData[t].disciplines) 
                    for(let p in processedData[t].disciplines[d].professors) 
                        profs.add(processedData[t].disciplines[d].professors[p].name.split(' (')[0]);
            
            sel.innerHTML = '<option value="">-- Selecione o Professor --</option>';
            Array.from(profs).sort().forEach(p => sel.innerHTML += `<option value="${p}">${p}</option>`);
        }

        window.gerarGradeSemanal = function() {
            const prof = document.getElementById('selectProfSemanal').value;
            const semanaValue = document.getElementById('inputSemana').value;
            const resultArea = document.getElementById('gradeSemanalResult');

            if (!prof || !semanaValue) return alert("Selecione Professor e Semana!");

            const tempos = ["19:00 - 19:50", "19:50 - 20:40", "20:50 - 21:40", "21:40 - 22:30"];
            const dias = ["Segunda-feira", "Terça-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "Sábado"];

            let html = `<table id="tabelaGradeExport" class="min-w-full border mt-4 text-xs">
                        <thead class="bg-green-700 text-white"><tr><th class="p-2 border">Horário</th>`;
            dias.forEach(d => html += `<th class="p-2 border">${d}</th>`);
            html += `</tr></thead><tbody class="bg-white">`;

            tempos.forEach(t => {
                html += `<tr><td class="p-2 border font-bold bg-gray-50">${t}</td>`;
                dias.forEach(d => {
                    let conteudo = "";
                    for(let tId in processedData) {
                        for(let dId in processedData[tId].disciplines) {
                            const disc = processedData[tId].disciplines[dId];
                            for(let pId in disc.professors) {
                                const pObj = disc.professors[pId];
                                if(pObj.name.includes(prof)) {
                                    const match = pObj.schedule.find(s => s.weekday === d && t.includes(s.time.split(' - ')[0]));
                                    if(match) conteudo = `${disc.name}<br><b>${processedData[tId].name}</b>`;
                                }
                            }
                        }
                    }
                    html += `<td class="p-2 border text-center">${conteudo}</td>`;
                });
                html += `</tr>`;
            });
            resultArea.innerHTML = html + `</tbody></table>`;
        };

        window.exportarGradeSemanalPDF = function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const prof = document.getElementById('selectProfSemanal').value;
            
            const centerText = (text, y, size, style = 'normal') => {
                doc.setFontSize(size); doc.setFont('helvetica', style);
                doc.text(text, 105, y, { align: 'center' });
            };

            centerText("INSTITUTO FEDERAL DE RONDÔNIA", 12, 11, 'bold');
            centerText("CAMPUS CACOAL", 17, 10, 'italic');
            centerText("RELATÓRIO DE HORÁRIOS - GRADE SEMANAL", 28, 9, 'bold');
            doc.setFontSize(9); doc.text(`Professor: ${prof}`, 14, 40);

            doc.autoTable({
                html: '#tabelaGradeExport',
                startY: 45,
                theme: 'grid',
                styles: { fontSize: 7, halign: 'center' },
                headStyles: { fillColor: [21, 128, 61] },
                didParseCell: function(data) {
                    if (data.section === 'body' && data.cell.text.join('').includes('INTERVALO')) {
                        data.cell.styles.fillColor = [240, 240, 240];
                    }
                }
            });

            // RODAPÉ OFICIAL
            const pageHeight = doc.internal.pageSize.getHeight();
            doc.setDrawColor(200); doc.line(10, pageHeight - 25, 200, pageHeight - 25);
            centerText("Rodovia BR 364, Km 228, Lote 2A - Zona Rural, CEP: 76960-970, Cacoal-RO", pageHeight - 20, 7);
            centerText("Telefone: 069-2182-9642 | E-mail: campuscacoal@ifro.edu.br", pageHeight - 15, 7);
            
            doc.save(`Grade_Semanal_${prof}.pdf`);
        };

        // --- PDF DISCIPILNA OFICIAL ---
        document.getElementById('exportDisciplinaPdfBtn').onclick = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const tText = document.getElementById('turmaSelect').options[document.getElementById('turmaSelect').selectedIndex].text;
            const dText = document.getElementById('disciplinaSelect').options[document.getElementById('disciplinaSelect').selectedIndex].text;

            doc.setFontSize(14); doc.text("IFRO - CAMPUS CACOAL", 105, 15, {align: 'center'});
            doc.setFontSize(10); doc.text(`Relatório de Dias Letivos: ${dText}`, 105, 22, {align: 'center'});
            doc.text(`Turma: ${tText}`, 105, 27, {align: 'center'});

            doc.autoTable({
                html: '#horariosTableDisciplina',
                startY: 35,
                theme: 'grid',
                headStyles: { fillColor: [21, 128, 61] }
            });
            doc.save(`Relatorio_${dText}.pdf`);
        };

    </script>
</body>
</html>
