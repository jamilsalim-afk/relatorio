<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios Pedagógicos - IFRO Campus Cacoal</title>
    <!-- Carrega o Tailwind CSS para o estilo responsivo e moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'ifro-primary': '#16A34A', 
                        'ifro-light': '#F3F4F6',
                    }
                }
            }
        }
    </script>
    <!-- Scripts para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- CSS CUSTOM para a Tab - Para garantir a cor ativa -->
    <style>
        .tab-btn.active {
            border-bottom: 3px solid #16A34A; /* ifro-primary */
            color: #16A34A; /* ifro-primary */
            font-weight: 700;
        }
        .ifro-header {
            background-color: #16A34A;
        }
    </style>
</head>
<body class="bg-ifro-light font-sans min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden">
        
        <!-- CABEÇALHO INSTITUCIONAL (FIXO NO TOPO) -->
        <header class="ifro-header text-white p-6 text-center rounded-t-xl">
            <h1 class="text-3xl font-extrabold mb-1">INSTITUTO FEDERAL DE RONDÔNIA</h1>
            <h2 class="text-2xl font-semibold italic mb-4">CAMPUS CACOAL</h2>
            <div class="h-0.5 bg-white opacity-20 mx-auto w-3/4 mb-4"></div>
            <p class="text-sm font-light mb-1">DEPARTAMENTO DE APOIO AO ENSINO</p>
            <p class="text-sm font-medium">COORDENAÇÃO DE DESENVOLVIMENTO DE FERRAMENTAS PEDAGÓGICAS</p>
        </header>
        
        <!-- NAVEGAÇÃO POR ABAS -->
        <nav id="tab-nav" class="flex border-b border-gray-200">
            <button id="btn-disciplina" data-tab="tab-disciplina" class="tab-btn active px-6 py-3 text-base text-gray-600 hover:text-ifro-primary transition duration-150 ease-in-out focus:outline-none">
                Consulta por Disciplina
            </button>
            <button id="btn-professores" data-tab="tab-professores" class="tab-btn px-6 py-3 text-base text-gray-600 hover:text-ifro-primary transition duration-150 ease-in-out focus:outline-none">
                Consulta por Turma
            </button>
            <button data-tab="tab-semanal" class="tab-btn px-6 py-3 text-base text-gray-600 hover:text-ifro-primary transition duration-150 ease-in-out focus:outline-none">
    Grade Semanal
</button>
        </nav>

        <!-- CORPO DA CONSULTA / CONTEÚDO DAS ABAS -->
        <main id="tab-content-area" class="p-6 md:p-8">
            
            <!-- INDICADOR DE CARREGAMENTO (Compartilhado) -->
            <div id="loadingIndicator" class="text-center p-4 bg-ifro-light rounded-lg font-bold text-ifro-primary mt-4">
                A carregar dados iniciais...
            </div>
            
            <!-- Mensagem de feedback (Compartilhado) -->
            <div id="feedbackMessage" class="hidden mt-4 p-3 rounded-lg text-center font-medium"></div>

            <!-- ABA 1: CONSULTA POR DISCIPLINA (Horário Agregado) -->
            <div id="tab-disciplina" class="tab-pane">
                <h3 class="text-xl font-bold text-gray-800 mb-6 border-b pb-2">Horários Agregados por Ano, Turma e Disciplina</h3>
                
                <!-- SEÇÃO DE INSTRUÇÕES EXPANSÍVEL -->
                <details class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg text-blue-800">
                    <summary class="font-bold cursor-pointer hover:text-blue-900 transition duration-150">
                        Clique para entender como usar a consulta
                    </summary>
                    <div class="mt-3 text-sm space-y-2">
                        <p>Esta ferramenta exibe o calendário multianual de uma disciplina específica do IFRO Campus Cacoal, utilizando dados extraídos de uma planilha CSV externa.</p>
                        <ul class="list-disc list-inside ml-4">
                            <li><strong>1. ANO LETIVO:</strong> Selecione o ano que deseja consultar.</li>
                            <li><strong>2. TURMA:</strong> Escolha a turma (ex: TADS 2023).</li>
                            <li><strong>3. DISCIPLINA:</strong> Selecione a disciplina. O sistema agrega os horários de todos os professores vinculados.</li>
                        </ul>
                        <p class="font-semibold text-xs pt-1">Aulas de Recuperação (REC) e Exame são destacadas em amarelo na tabela, mas são automaticamente excluídas da contagem total de dias de aula.</p>
                    </div>
                </details>
                
                <!-- ÁREA DE FILTROS DA DISCIPLINA -->
                <div id="filterAreaDisciplina" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 mb-8 hidden">
                    
                    <!-- 1. SELETOR DE ANO (Compartilhado) -->
                    <div>
                        <label for="yearSelect" class="block text-sm font-bold text-gray-700 mb-1">ANO LETIVO</label>
                        <select id="yearSelect" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-ifro-primary focus:border-ifro-primary transition duration-150 ease-in-out">
                            <!-- Opções preenchidas via JavaScript -->
                        </select>
                    </div>

                    <!-- 2. SELETOR DE TURMA -->
                    <div>
                        <label for="turmaSelect" class="block text-sm font-bold text-gray-700 mb-1">TURMA</label>
                        <select id="turmaSelect" disabled class="w-full p-3 border border-gray-300 bg-gray-100 rounded-lg shadow-sm focus:ring-ifro-primary focus:border-ifro-primary transition duration-150 ease-in-out">
                            <option value="">-- Selecione a Turma --</option>
                        </select>
                    </div>

                    <!-- 3. SELETOR DE DISCIPLINA -->
                    <div>
                        <label for="disciplinaSelect" class="block text-sm font-bold text-gray-700 mb-1">DISCIPLINA</label>
                        <select id="disciplinaSelect" disabled class="w-full p-3 border border-gray-300 bg-gray-100 rounded-lg shadow-sm focus:ring-ifro-primary focus:border-ifro-primary transition duration-150 ease-in-out">
                            <option value="">-- Selecione uma Disciplina --</option>
                        </select>
                    </div>
                </div>

                <!-- BOTÃO DE EXPORTAÇÃO E SUMÁRIO DE DIAS (DISCIPLINA) -->
                <div id="exportAreaDisciplina" class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8 p-4 bg-ifro-light rounded-lg border border-gray-200 hidden">
                    <button id="exportDisciplinaPdfBtn" disabled class="w-full sm:w-auto px-6 py-3 text-lg font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 transition duration-150 ease-in-out shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                        Exportar Relatório em PDF (Disciplina)
                    </button>
                    <div class="text-gray-700 text-base font-semibold">
                        Total de Dias de Aula (Exclui REC/Exame): <span id="totalDiasDisciplina" class="text-xl text-ifro-primary font-extrabold">0</span>
                    </div>
                </div>

                <!-- TABELA DE RESULTADOS DA DISCIPLINA -->
                <div id="tableContainerDisciplina" class="overflow-x-auto border border-gray-300 rounded-lg shadow-lg">
                    <table id="horariosTableDisciplina" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Mês</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Dia do Mês</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Dia da Semana</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Horário da Aula</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Professor</th>
                            </tr>
                        </thead>
                        <tbody id="tableBodyDisciplina" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500 italic">Aguardando dados...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
            </div>
            
            <!-- ABA 2: RELATÓRIO TURMA X MÊS (Implementado como Tabela Pivô) -->
            <div id="tab-professores" class="tab-pane hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-6 border-b pb-2">Consulta por Turma: Carga Horária Mensal por Disciplina</h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- 1. SELETOR DE ANO (Clone para sincronia visual, usa o evento do original) -->
                    <div id="yearSelectProfessorContainer">
                        <label for="yearSelect" class="block text-sm font-bold text-gray-700 mb-1">ANO LETIVO</label>
                        <select id="yearSelectProfessor" disabled class="w-full p-3 border border-gray-300 bg-gray-100 rounded-lg shadow-sm focus:ring-ifro-primary focus:border-ifro-primary transition duration-150 ease-in-out">
                            <!-- JS copiará opções do yearSelect -->
                        </select>
                    </div>
                    
                    <!-- 2. SELETOR DE TURMA PARA RELATÓRIO PIVÔ -->
                    <div>
                        <label for="turmaSelectProfessor" class="block text-sm font-bold text-gray-700 mb-1">SELECIONE A TURMA</label>
                        <select id="turmaSelectProfessor" disabled class="w-full p-3 border border-gray-300 bg-gray-100 rounded-lg shadow-sm focus:ring-ifro-primary focus:border-ifro-primary transition duration-150 ease-in-out">
                            <option value="">-- Selecione a Turma --</option>
                        </select>
                    </div>
                </div>

                <!-- BOTÃO DE EXPORTAÇÃO (RELATÓRIO PIVÔ) -->
                <div id="exportAreaProfessor" class="flex justify-start mb-8 p-4 bg-ifro-light rounded-lg border border-gray-200 hidden">
                    <button id="exportProfessorPdfBtn" disabled class="px-6 py-3 text-lg font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 transition duration-150 ease-in-out shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                        Exportar Relatório em PDF (Turma)
                    </button>
                </div>

                <!-- TABELA DE RESULTADOS DO PROFESSOR (PIVÔ) -->
                <div id="tableContainerProfessor" class="overflow-x-auto border border-gray-300 rounded-lg shadow-lg">
                    <table id="horariosPivotTableProfessor" class="min-w-full divide-y divide-gray-200">
                        <!-- Cabeçalho será gerado dinamicamente -->
                        <thead class="bg-gray-50">
                            <tr>
                                <!-- Redução do padding para px-3 py-2 e fonte mantida em text-xs e font-bold -->
                                <th class="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Disciplina</th>
                                <th class="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Jan</th>
                                <th class="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Fev</th>
                                <th class="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Mar</th>
                                <th class="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Abr</th>
                                <th class="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Mai</th>
                                <th class="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Jun</th>
                                <th class="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Jul</th>
                                <th class="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Ago</th>
                                <th class="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Set</th>
                                <th class="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Out</th>
                                <th class="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Nov</th>
                                <th class="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Dez</th>
                                <th class="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-200 text-gray-700">SÁBADO</th> 
                                <th class="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase tracking-wider bg-ifro-primary text-white">Total</th>
                            </tr>
                        </thead>
                        <tbody id="tableBodyProfessorPivot" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="15" class="px-6 py-4 text-center text-sm text-gray-500 italic">Selecione a turma para visualizar a carga horária por disciplina e mês.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </div>
              <!-- ABA 3: RELATÓRIO PROFESSOR SAMANAL (Implementado como Tabela Pivô) -->
<div id="tab-semanal" class="tab-pane hidden animate-fadeIn">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
            <span class="w-2 h-6 bg-ifro-primary rounded-full mr-3"></span>
            Grade Semanal por Professor
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 bg-gray-50 p-4 rounded-lg">
            <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Professor</label>
                <select id="selectProfSemanal" class="w-full p-2.5 bg-white border border-gray-300 rounded-lg outline-none text-sm"></select>
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Escolha a Semana</label>
                <input type="week" id="inputSemana" class="w-full p-2.5 bg-white border border-gray-300 rounded-lg outline-none text-sm">
            </div>
            <div class="flex flex-col md:flex-row gap-2 items-end">
   <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
   <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
    <button onclick="gerarGradeSemanal()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-md flex items-center justify-center transition-all">
        <i class="fas fa-sync-alt mr-2"></i> Gerar Grade Semanal
    </button>
    <button onclick="exportarGradeSemanalPDF()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-md flex items-center justify-center transition-all">
        <i class="fas fa-file-pdf mr-2"></i> Exportar Relatório em PDF (Professor)
    </button>
</div>
        </div>

        <div id="gradeSemanalResult" class="overflow-x-auto rounded-lg border border-gray-200">
            <div class="text-center py-10 text-gray-400 italic text-sm">
                Selecione o professor e a semana desejada.
            </div>
        </div>
    </div>
</div>
        </main>

        <!-- RODAPÉ -->
        <footer class="p-4 bg-gray-100 text-center text-xs text-gray-600 border-t rounded-b-xl">
            <span id="dataRelatorio"></span> / Campus Cacoal
        </footer>

    </div>

    <script type="module">
        
        // =========================================================================
        // 1. CONFIGURAÇÃO DA FONTE DE DADOS (GIST)
        // =========================================================================
        
        const GIST_URLS = {
            // LINK ATUALIZADO para 2025:
            '2025': 'https://gist.githubusercontent.com/jamilsalim-afk/b8ff629ba4181ff68b988910e43fcefc/raw/799bb00af8e38569af8969c933df570f970858d7/2025.csv', 
            // URL configurada como RAW (crua) do Gist. 
            '2027': 'https://placeholder.com/2027_gist_url_csv', 
            '2028': 'https://placeholder.com/2028_gist_url_csv', 
            '2029': 'https://placeholder.com/2029_gist_url_csv', 
            '2030': 'https://placeholder.com/2030_gist_url_csv'  
        };
        
        const DEFAULT_YEAR = '2025'; 

        // Estrutura de Fallback (para testes se o Gist falhar)
        const fallbackScheduleData = [
            {A: "Setembro", B: "5", C: "Terça-feira", D: "19:00 - 20:40", E: "TADS - 2023", F: "Programação Web I - Prof. Jamil Salim"},
            {A: "Setembro", B: "7", C: "Quinta-feira", D: "20:50 - 22:30", E: "TADS - 2023", F: "Banco de Dados I - Prof. Ana Paula"},
            // Aulas em outros meses para a Turma TADS - 2023
            {A: "Outubro", B: "10", C: "Terça-feira", D: "19:00 - 20:40", E: "TADS - 2023", F: "Programação Web I - Prof. Jamil Salim"},
            {A: "Outubro", B: "12", C: "Quinta-feira", D: "20:50 - 22:30", E: "TADS - 2023", F: "Banco de Dados I - Prof. Ana Paula"},
            // Turma diferente para testar o pivô (INCLUINDO SÁBADO)
            {A: "Março", B: "15", C: "Sábado", D: "10:00 - 11:40", E: "Agroecologia 2024", F: "Matemática Aplicada - Prof. Jamil Salim"}, // <-- SÁBADO
            {A: "Abril", B: "20", C: "Sábado", D: "08:00 - 09:40", E: "Agroecologia 2024", F: "Matemática Aplicada - Prof. Jamil Salim"}, // <-- SÁBADO
            // Exemplo de professor com (REC) - Deve ser ignorado na contagem
            {A: "Outubro", B: "12", C: "Quinta-feira", D: "19:00 - 20:40", E: "TADS 2023", F: "Programação Web I - Prof. Ricardo Silva (REC)"}, 
            // Exemplo de professor com (Exame) - Deve ser ignorado na contagem
            {A: "Novembro", B: "15", C: "Quarta-feira", D: "19:00 - 22:30", E: "TADS/2023", F: "Programação Web I - Prof. Maria Eduarda (Exame)"}, 
        ];

        // Mapeamento das colunas CSV para as chaves internas (A, B, C, D, E, F)
        const CSV_COLUMNS = ['A', 'B', 'C', 'D', 'E', 'F']; 
        
        // Delimitador padrão: PONTO E VÍRGULA (;)
        const CSV_DELIMITER = ';'; 

        // =========================================================================
        // CONSTANTES DE FILTRAGEM
        // =========================================================================
        
        const DISCIPLINES_TO_IGNORE = [
            'Afastamento', 
            'Férias', 
            'Reunião Pedagógica',
            'Compromisso Institucional',
            'PPS/Atendimento', 
            'Estudos Individuais', 
            'Atendimento Individual', 
            'Reunião de Servidores', 
            'Reserva Ensino'
        ];
        
        const REC_TERM = '(REC)';
        const EXAME_TERM = '(Exame)';
        
        const MONTH_MAP_PIVOT = {
            'janeiro': 'Jan', 'fevereiro': 'Fev', 'março': 'Mar', 
            'abril': 'Abr', 'maio': 'Mai', 'junho': 'Jun', 
            'julho': 'Jul', 'agosto': 'Ago', 'setembro': 'Set', 
            'outubro': 'Out', 'novembro': 'Nov', 'dezembro': 'Dez'
        };


        // =========================================================================
        // 2. VARIÁVEIS DE ESTADO E REFERÊNCIAS DOM
        // =========================================================================
        
        let processedData = {};
        let currentScheduleDisciplina = []; // Dados para a Aba 1
        let currentYear = DEFAULT_YEAR; 
        
        // Referências aos elementos do DOM
        const yearSelect = document.getElementById('yearSelect'); 
        const turmaSelect = document.getElementById('turmaSelect');
        const disciplinaSelect = document.getElementById('disciplinaSelect');
        const tableBodyDisciplina = document.getElementById('tableBodyDisciplina');
        const totalDiasDisciplinaSpan = document.getElementById('totalDiasDisciplina');
        const exportDisciplinaPdfBtn = document.getElementById('exportDisciplinaPdfBtn');
        const dataRelatorioSpan = document.getElementById('dataRelatorio');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const filterAreaDisciplina = document.getElementById('filterAreaDisciplina');
        const exportAreaDisciplina = document.getElementById('exportAreaDisciplina');
        
        // Novas referências para a ABA PIVÔ
        const yearSelectProfessor = document.getElementById('yearSelectProfessor');
        const turmaSelectProfessor = document.getElementById('turmaSelectProfessor');
        const tableBodyProfessorPivot = document.getElementById('tableBodyProfessorPivot');
        const exportProfessorPdfBtn = document.getElementById('exportProfessorPdfBtn');
        const exportAreaProfessor = document.getElementById('exportAreaProfessor');


        // =========================================================================
        // 3. FUNÇÕES UTILITÁRIAS E CARREGAMENTO DE DADOS
        // =========================================================================

        /**
         * Converte o texto RAW de um CSV em uma array de objetos.
         */
        function parseCSV(csvText) {
            // 1. Normaliza as quebras de linha e remove colchetes (se ainda existirem)
            const normalizedText = csvText
                .replace(/\r\n/g, '\n').replace(/\r/g, '\n')
                .replace(/\[|\]/g, ''); 
            
            const lines = normalizedText.split('\n').filter(line => line.trim() !== '');
            
            if (lines.length <= 1) { 
                console.warn("CSV PARSER: O arquivo não contém linhas de dados válidas (apenas o cabeçalho ou está vazio).");
                return [];
            }

            // IGNORA A PRIMEIRA LINHA (CABECALHO)
            const dataLines = lines.slice(1); 
            const dataArray = [];

            for (const line of dataLines) {
                // Divide a linha pelo delimitador.
                const values = line.split(CSV_DELIMITER);
                
                const trimmedValues = values.map(v => (v || '').trim());
                
                if (trimmedValues.length < CSV_COLUMNS.length) {
                    // console.warn(`CSV PARSER WARNING: Linha ignorada por número incorreto de colunas. Linha: ${line.substring(0, 100)}...`);
                    continue;
                }

                const dataObject = {};
                for (let i = 0; i < CSV_COLUMNS.length; i++) {
                    dataObject[CSV_COLUMNS[i]] = trimmedValues[i]; 
                }
                dataArray.push(dataObject);
            }
            console.log(`CSV PARSER SUCESSO: Foram analisadas ${dataArray.length} linhas de dados válidas.`);
            return dataArray;
        }

        /**
         * Gera um ID seguro para uso como chave.
         */
        function generateId(name) {
            return name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9\s-]/g, '').toLowerCase().trim().replace(/\s+/g, '-');
        }
        
        /**
         * Carrega os dados do Gist (URL RAW) para o ano especificado com retries (backoff).
         */
        async function loadDataFromGist(year, retries = 3, delay = 1000) {
            const url = GIST_URLS[year];
            
            // Desativa botões e filtros
            turmaSelect.disabled = true;
            disciplinaSelect.disabled = true;
            exportDisciplinaPdfBtn.disabled = true;
            turmaSelectProfessor.disabled = true;
            exportProfessorPdfBtn.disabled = true;
            
            loadingIndicator.classList.remove('hidden');
            filterAreaDisciplina.classList.add('hidden');
            exportAreaDisciplina.classList.add('hidden');
            exportAreaProfessor.classList.add('hidden');

            if (!url || url.includes('placeholder')) {
                showFeedback(`URL do Gist para ${year} não configurada. Usando dados de exemplo (Fallback).`, 'bg-red-100 text-red-800');
                
                processAndRenderData(fallbackScheduleData);
                return;
            }

            loadingIndicator.textContent = `A carregar horários para o ano ${year} (Tentativa 1/${retries})...`;

            for (let i = 0; i < retries; i++) {
                try {
                    loadingIndicator.textContent = `A carregar horários para o ano ${year} (Tentativa ${i + 1}/${retries})...`;
                    
                    const response = await fetch(url);

                    if (!response.ok) {
                        if (response.status === 404 || response.status === 403) {
                             throw new Error(`Erro: O recurso na URL (${url}) retornou status ${response.status}. Verifique se o link está ativo e é a versão RAW.`);
                        }
                        throw new Error(`Erro de rede: Status ${response.status}.`);
                    }

                    const rawText = await response.text();
                    
                    let rawDataArray;
                    try {
                        rawDataArray = parseCSV(rawText);
                        if (rawDataArray.length === 0) {
                            throw new Error(`O arquivo CSV/TXT está vazio ou o formato/delimitador ("${CSV_DELIMITER}") está incorreto.`);
                        }
                    } catch (e) {
                        console.error("ERRO CRÍTICO: Falha ao analisar CSV.", e);
                        throw new Error("O Gist tem um formato CSV inválido ou não contém dados válidos.");
                    }

                    processAndRenderData(rawDataArray);
                    return; 
                    
                } catch (error) {
                    console.error(`Tentativa ${i + 1} falhou:`, error.message);
                    if (i === retries - 1) {
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }

            console.error(`Todas as ${retries} tentativas falharam. Usando dados de fallback.`);
            showFeedback(`Erro crítico ao carregar a URL do Gist (${url}). Todas as tentativas falharam. Usando dados de exemplo (Fallback).`, 'bg-red-100 text-red-800');
            processAndRenderData(fallbackScheduleData);
        }

        /**
         * Processa a lista de objetos (agora vindos do CSV) para a estrutura hierárquica 
         * Turma > Disciplina > Professor > Horário.
         */
        function processAndRenderData(dataArray) {
            const data = {};
            
            dataArray.forEach((item) => {
                let turmaNameRaw = item.E?.toString().trim();
                
                // --- NORMALIZAÇÃO DA TURMA: Essencial para agrupamento consistente ---
                const turmaNameNormalized = (turmaNameRaw || '')
                    .replace(/[-–—/]/g, ' ') 
                    .replace(/\s+/g, ' ') 
                    .trim();

                const combinedDisciplineProfessor = item.F?.toString().trim(); 
                const month = item.A?.toString().trim();
                const dayOfMonth = item.B;
                const dayOfWeek = item.C?.toString().trim();
                const time = item.D?.toString().trim();

                let disciplineName = 'Disciplina Não Informada';
                let professorName = 'Professor(a) Desconhecido(a)';
                let isRecuperacao = false; 

                if (combinedDisciplineProfessor) {
                    const hyphenIndex = combinedDisciplineProfessor.indexOf('-');
                    
                    if (hyphenIndex !== -1) {
                        disciplineName = combinedDisciplineProfessor.substring(0, hyphenIndex).trim();
                        professorName = combinedDisciplineProfessor.substring(hyphenIndex + 1).trim();
                    } else {
                        disciplineName = combinedDisciplineProfessor;
                    }
                }
                
                // --- FILTRO 1: Disciplinas a ignorar (internas/administrativas) ---
                if (DISCIPLINES_TO_IGNORE.includes(disciplineName)) {
                    return; 
                }
                
                // --- NOVA LÓGICA: DETECTA AULAS (REC) OU (Exame) PARA NÃO CONTAR ---
                const upperProfessorName = professorName.toUpperCase();
                if (
                    upperProfessorName.includes(REC_TERM.toUpperCase()) ||
                    upperProfessorName.includes(EXAME_TERM.toUpperCase()) 
                ) {
                    isRecuperacao = true;
                }
                
                // Verifica se os campos essenciais existem (agora usando o nome normalizado)
                const parsedDayOfMonth = parseInt(dayOfMonth, 10);
                if (!turmaNameNormalized || !disciplineName || !month || !dayOfWeek || !time || isNaN(parsedDayOfMonth)) {
                    return; 
                }
                
                const turmaId = generateId(turmaNameNormalized); 
                const disciplinaId = generateId(disciplineName);
                const professorId = generateId(professorName); 

                // 1. Inicializa a Turma
                if (!data[turmaId]) {
                    data[turmaId] = { name: turmaNameNormalized, disciplines: {} };
                }

                // 2. Inicializa a Disciplina
                if (!data[turmaId].disciplines[disciplinaId]) {
                    data[turmaId].disciplines[disciplinaId] = {
                        name: disciplineName,
                        professors: {}
                    };
                }
                
                // 3. Inicializa o Professor
                const discipline = data[turmaId].disciplines[disciplinaId];
                if (!discipline.professors[professorId]) {
                    discipline.professors[professorId] = {
                        name: professorName,
                        schedule: [] 
                    };
                }

                // 4. Adiciona o horário
                discipline.professors[professorId].schedule.push({
                    month: month,
                    dayOfMonth: parsedDayOfMonth,
                    dayOfWeek: dayOfWeek, // Mantido para a lógica do SÁBADO
                    time: time,
                    isRecuperacao: isRecuperacao,
                    turmaName: turmaNameNormalized, 
                    disciplineName: disciplineName 
                });
            });

            processedData = data;
            
            // Atualiza os seletores de ambas as abas
            populateTurmaSelect();
            populateTurmaProfessorSelect();
            populateProfessoresGrade();
            
            loadingIndicator.classList.add('hidden');
            filterAreaDisciplina.classList.remove('hidden');
            showFeedback('Dados processados com sucesso. Selecione uma Turma.', 'bg-green-100 text-green-800');
        }

        // =========================================================================
        // 4. FUNÇÕES DE LÓGICA (UI) E ABAS
        // =========================================================================
        
        /**
         * Exibe a aba de conteúdo solicitada e atualiza o estado do botão de navegação.
         */
        function showTab(tabId) {
            // 1. Oculta todos os painéis de abas
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.add('hidden');
            });

            // 2. Remove o estado ativo de todos os botões
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // 3. Exibe o painel de abas selecionado
            const activePane = document.getElementById(tabId);
            if (activePane) {
                activePane.classList.remove('hidden');
            }
            
            // 4. Define o botão correspondente como ativo
            const activeButton = document.querySelector(`[data-tab="${tabId}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }
        
        function initApp() {
            dataRelatorioSpan.textContent = new Date().toLocaleDateString('pt-BR');

            // 1. Adiciona listeners
            yearSelect.addEventListener('change', handleYearChange);
            turmaSelect.addEventListener('change', handleTurmaChange); // Aba Disciplina
            disciplinaSelect.addEventListener('change', handleDisciplinaChange); // Aba Disciplina
            exportDisciplinaPdfBtn.addEventListener('click', exportDisciplinaReportToPdf); // Aba Disciplina
            
            turmaSelectProfessor.addEventListener('change', handleTurmaProfessorChange); // Aba Pivô
            exportProfessorPdfBtn.addEventListener('click', exportProfessorPivotReportToPdf); // Aba Pivô
            
            // Adiciona listeners para os botões de aba
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabId = e.target.getAttribute('data-tab');
                    showTab(tabId);
                });
            });
            
            // 2. Preenche o seletor de ano
            populateYearSelect();
            
            // 3. Inicia o carregamento de dados para o ano padrão
            loadDataFromGist(currentYear);
            
            // 4. Exibe a primeira aba por padrão
            showTab('tab-disciplina');
        }
        
        function populateYearSelect() {
            const years = Object.keys(GIST_URLS).sort((a, b) => parseInt(a) - parseInt(b));
            yearSelect.innerHTML = '';
            yearSelectProfessor.innerHTML = ''; // Limpa o seletor da aba pivô
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                
                const optionPivot = option.cloneNode(true);
                
                yearSelect.appendChild(option);
                yearSelectProfessor.appendChild(optionPivot); // Preenche o seletor da aba pivô
            });
            
            yearSelect.value = DEFAULT_YEAR;
            yearSelectProfessor.value = DEFAULT_YEAR;
            
            // Habilita os seletores de ano
            yearSelect.disabled = false;
            yearSelectProfessor.disabled = false;
            yearSelectProfessor.classList.remove('bg-gray-100');
        }

        function handleYearChange(event) {
            const selectedYear = event.target.value;
            currentYear = selectedYear;
            
            // Sincroniza o outro seletor de ano
            yearSelect.value = selectedYear;
            yearSelectProfessor.value = selectedYear;
            
            // Limpa todas as seleções dependentes
            turmaSelect.innerHTML = '<option value="">-- Selecione a Turma --</option>';
            disciplinaSelect.innerHTML = '<option value="">-- Selecione uma Disciplina --</option>';
            turmaSelectProfessor.innerHTML = '<option value="">-- Selecione a Turma --</option>';
            
            renderTableDisciplina([]);
            renderPivotTable({}); // Limpa a tabela pivô
            
            loadDataFromGist(currentYear);
        }
        
        // =========================================================================
        // LÓGICA: ABA 1 (DISCIPLINA)
        // =========================================================================
        
        function populateTurmaSelect() {
            const currentTurmaValue = turmaSelect.value;
            
            // Limpa e desabilita os seletores dependentes
            disciplinaSelect.innerHTML = '<option value="">-- Selecione uma Disciplina --</option>';
            disciplinaSelect.disabled = true;
            disciplinaSelect.classList.add('bg-gray-100');

            exportDisciplinaPdfBtn.disabled = true;
            
            turmaSelect.innerHTML = '<option value="">-- Selecione a Turma --</option>';
            
            for (const key in processedData) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = processedData[key].name; 
                turmaSelect.appendChild(option);
            }
            
            if (Object.keys(processedData).length > 0) {
                turmaSelect.disabled = false;
                turmaSelect.classList.remove('bg-gray-100');
            } else {
                turmaSelect.disabled = true;
                turmaSelect.classList.add('bg-gray-100');
                renderTableDisciplina([]);
            }
            
            if (currentTurmaValue && processedData[currentTurmaValue]) {
                turmaSelect.value = currentTurmaValue;
                handleTurmaChange({ target: { value: currentTurmaValue } });
            }
        }

        /**
         * Lida com a mudança da Turma, populando as Disciplinas.
         */
        function handleTurmaChange(event) {
            const selectedTurma = event.target.value;
            
            disciplinaSelect.innerHTML = '<option value="">-- Selecione uma Disciplina --</option>';
            disciplinaSelect.disabled = true;
            disciplinaSelect.classList.add('bg-gray-100');
            
            renderTableDisciplina([]);
            exportDisciplinaPdfBtn.disabled = true;

            if (selectedTurma && processedData[selectedTurma]) {
                const disciplines = processedData[selectedTurma].disciplines;
                
                const disciplineKeys = Object.keys(disciplines);
                disciplineKeys.sort((keyA, keyB) => {
                    const nameA = disciplines[keyA].name.toUpperCase();
                    const nameB = disciplines[keyB].name.toUpperCase();
                    if (nameA < nameB) return -1;
                    if (nameA > nameB) return 1;
                    return 0;
                });
                
                for (const key of disciplineKeys) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = disciplines[key].name;
                    disciplinaSelect.appendChild(option);
                }
                
                disciplinaSelect.disabled = false;
                disciplinaSelect.classList.remove('bg-gray-100');
            }
        }

        /**
         * Lida com a mudança da Disciplina, agregando e exibindo os horários de todos os professores.
         */
        function handleDisciplinaChange(event) {
            const selectedTurma = turmaSelect.value;
            const selectedDiscipline = event.target.value;
            
            currentScheduleDisciplina = [];
            exportDisciplinaPdfBtn.disabled = true;
            renderTableDisciplina([]);

            if (selectedTurma && selectedDiscipline) {
                const disciplineData = processedData[selectedTurma].disciplines[selectedDiscipline];
                
                for (const professorId in disciplineData.professors) {
                    const professor = disciplineData.professors[professorId];
                    
                    const schedulesWithProfessor = professor.schedule.map(item => ({
                        ...item,
                        professorName: professor.name, 
                        isRecuperacao: item.isRecuperacao 
                    }));
                    
                    currentScheduleDisciplina.push(...schedulesWithProfessor);
                }
                
                renderTableDisciplina(currentScheduleDisciplina);
                exportAreaDisciplina.classList.remove('hidden');
                exportDisciplinaPdfBtn.disabled = currentScheduleDisciplina.length === 0;
            } else {
                 exportAreaDisciplina.classList.add('hidden');
            }
        }
        
        /**
         * Renderiza a tabela de horários da ABA 1 (Disciplina).
         */
        function renderTableDisciplina(schedule) {
            tableBodyDisciplina.innerHTML = '';
            
            if (schedule && schedule.length > 0) {
                
                const monthOrder = {
                    "janeiro": 1, "fevereiro": 2, "março": 3, "abril": 4, 
                    "maio": 5, "junho": 6, "julho": 7, "agosto": 8, 
                    "setembro": 9, "outubro": 10, "novembro": 11, "dezembro": 12
                };
                
                schedule.sort((a, b) => {
                    const monthA = monthOrder[a.month.toLowerCase()] || 0;
                    const monthB = monthOrder[b.month.toLowerCase()] || 0;

                    if (monthA !== monthB) return monthA - monthB;
                    if (a.dayOfMonth !== b.dayOfMonth) return a.dayOfMonth - b.dayOfMonth;
                    if (a.time < b.time) return -1;
                    if (a.time > b.time) return 1;
                    return 0; 
                });
                
                const regularClasses = schedule.filter(item => !item.isRecuperacao);
                totalDiasDisciplinaSpan.textContent = regularClasses.length;

                schedule.forEach((item, index) => {
                    const row = tableBodyDisciplina.insertRow();
                    
                    if (item.isRecuperacao) {
                        row.classList.add('bg-yellow-100', 'hover:bg-yellow-200'); 
                    } else {
                        row.classList.add(index % 2 === 0 ? 'bg-white' : 'bg-gray-50', 'hover:bg-gray-50');
                    }

                    row.insertCell().textContent = item.month;
                    row.insertCell().textContent = item.dayOfMonth;
                    row.insertCell().textContent = item.dayOfWeek;
                    row.insertCell().textContent = item.time;
                    row.insertCell().textContent = item.professorName; 
                    
                    Array.from(row.cells).forEach(cell => {
                        cell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-900');
                    });
                });
                
            } else {
                const row = tableBodyDisciplina.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 5; 
                cell.classList.add('px-6', 'py-4', 'text-center', 'text-sm', 'text-gray-500', 'italic');
                
                cell.textContent = 'Selecione a turma e a disciplina para ver os horários.';
                
                totalDiasDisciplinaSpan.textContent = 0;
            }
        }
        
        /**
         * Gera e descarrega o relatório de horários em formato PDF da ABA 1.
         */
        async function exportDisciplinaReportToPdf() {
            if (!disciplinaSelect.value) return;

            exportDisciplinaPdfBtn.disabled = true;
            exportDisciplinaPdfBtn.textContent = 'Gerando PDF...';
            showFeedback('Gerando relatório PDF...', 'bg-yellow-100 text-yellow-800');

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            let y = margin;
            
            const selectedYearText = yearSelect.options[yearSelect.selectedIndex].text;
            const selectedTurmaText = turmaSelect.options[turmaSelect.selectedIndex].text;
            const selectedDisciplinaText = disciplinaSelect.options[disciplinaSelect.selectedIndex].text;
            
            const totalDiasText = totalDiasDisciplinaSpan.textContent; 
            const professorNames = Array.from(new Set(currentScheduleDisciplina.map(item => item.professorName))).join(' / ');


            const addCenteredText = (text, size, style = 'normal') => {
                doc.setFont('helvetica', style);
                doc.setFontSize(size);
                const textWidth = doc.getStringUnitWidth(text) * size / doc.internal.scaleFactor;
                const x = (pageWidth - textWidth) / 2;
                doc.text(text, x, y);
                y += size * 0.4;
            };

            y += 5;
            addCenteredText('INSTITUTO FEDERAL DE RONDÔNIA', 14, 'bold');
            addCenteredText('CAMPUS CACOAL', 12, 'italic');
            y += 5;
            addCenteredText('DEPARTAMENTO DE APOIO AO ENSINO', 10);
            addCenteredText('COORDENAÇÃO DE DESENVOLVIMENTO DE FERRAMENTAS PEDAGÓGICAS', 10);
            
            y += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(`Relatório de Horários de Aula (Disciplina Agregada) - Ano ${selectedYearText}`, margin, y);
            y += 5;
            doc.setFont('helvetica', 'normal');
            doc.text(`Turma: ${selectedTurmaText}`, margin, y);
            y += 5;
            doc.text(`Disciplina: ${selectedDisciplinaText}`, margin, y);
            y += 5;
            doc.text(`Professores Envolvidos: ${professorNames}`, margin, y); 
            y += 5;
            doc.text(`Total de Dias de Aula (Excluindo horários REC e Exame): ${totalDiasText}`, margin, y);
            y += 10;
            
            const headers = [["Mês", "Dia do Mês", "Dia da Semana", "Horário da Aula", "Professor"]]; 
            
            const data = currentScheduleDisciplina.map(item => [
                item.month, 
                item.dayOfMonth.toString(), 
                item.dayOfWeek, 
                item.time,
                item.professorName 
            ]);

            doc.autoTable({
                head: headers,
                body: data,
                startY: y,
                theme: 'striped',
                headStyles: { fillColor: [22, 163, 74], fontStyle: 'bold' },
                styles: { fontSize: 8, cellPadding: 2 },
                margin: { top: margin, bottom: margin, left: margin, right: margin },
                didDrawPage: function (data) {
                    const footerText = `${dataRelatorioSpan.textContent} / Campus Cacoal`;
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    const textWidth = doc.getStringUnitWidth(footerText) * 8 / doc.internal.scaleFactor;
                    const x = (pageWidth - textWidth) / 2;
                    doc.text(footerText, x, doc.internal.pageSize.getHeight() - 10);
                }
            });

            const fileName = `Relatorio_${selectedYearText}_${selectedTurmaText.replace(/\s/g, '_')}_${selectedDisciplinaText.replace(/\s/g, '_')}_Agregado.pdf`;
            doc.save(fileName);

            exportDisciplinaPdfBtn.disabled = false;
            exportDisciplinaPdfBtn.textContent = 'Exportar Relatório em PDF (Disciplina)';
            showFeedback('Relatório PDF gerado com sucesso!', 'bg-green-100 text-green-800');
        }

        
        // =========================================================================
        // LÓGICA: ABA 2 (RELATÓRIO PIVÔ)
        // =========================================================================

        function populateTurmaProfessorSelect() {
            turmaSelectProfessor.innerHTML = '<option value="">-- Selecione a Turma --</option>';
            exportProfessorPdfBtn.disabled = true;
            exportAreaProfessor.classList.add('hidden');
            renderPivotTable({}); // Limpa a tabela

            for (const key in processedData) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = processedData[key].name; 
                turmaSelectProfessor.appendChild(option);
            }
            
            if (Object.keys(processedData).length > 0) {
                turmaSelectProfessor.disabled = false;
                turmaSelectProfessor.classList.remove('bg-gray-100');
            } else {
                turmaSelectProfessor.disabled = true;
                turmaSelectProfessor.classList.add('bg-gray-100');
            }
        }
        
        /**
         * Lida com a mudança da Turma na ABA PIVÔ e gera os dados do relatório.
         */
        function handleTurmaProfessorChange(event) {
            const selectedTurmaId = event.target.value;
            
            exportProfessorPdfBtn.disabled = true;
            exportAreaProfessor.classList.add('hidden');
            renderPivotTable({});

            if (!selectedTurmaId || !processedData[selectedTurmaId]) {
                return;
            }
            
            const turmaData = processedData[selectedTurmaId].disciplines;
            const pivotData = {};

            // 1. Inicializa a estrutura do pivô e agrega todos os horários da turma
            for (const disciplineId in turmaData) {
                const disciplineName = turmaData[disciplineId].name;
                
                // Inicializa a linha do pivô para esta disciplina
                const initialRow = { total: 0, "Sábado": 0 }; // Adiciona o contador de Sábado
                Object.keys(MONTH_MAP_PIVOT).forEach(monthKey => {
                    initialRow[MONTH_MAP_PIVOT[monthKey]] = 0;
                });
                pivotData[disciplineName] = initialRow;

                // 2. Itera sobre todos os professores da disciplina para somar os horários
                for (const professorId in turmaData[disciplineId].professors) {
                    const schedule = turmaData[disciplineId].professors[professorId].schedule;
                    
                    schedule.forEach(item => {
                        // ** IGNORA REC/EXAME NA CONTAGEM **
                        if (item.isRecuperacao) {
                            return; 
                        }

                        // Lógica de contagem mensal
                        const monthKey = item.month.toLowerCase();
                        const monthColumn = MONTH_MAP_PIVOT[monthKey];
                        
                        if (monthColumn) {
                            pivotData[disciplineName][monthColumn] += 1;
                        }

                        // Lógica de contagem SÁBADO (não é exclusivo do mês, mas sim agregado)
                        if (item.dayOfWeek.toLowerCase().includes('sábado')) {
                            pivotData[disciplineName]["Sábado"] += 1;
                        }
                        
                        // Total (soma todas as aulas regulares)
                        pivotData[disciplineName].total += 1;
                    });
                }
            }

            renderPivotTable(pivotData, processedData[selectedTurmaId].name);
            exportAreaProfessor.classList.remove('hidden');
            exportProfessorPdfBtn.disabled = Object.keys(pivotData).length === 0;
        }


        /**
         * Renderiza a tabela de horários PIVÔ (Turma x Mês) da ABA 2.
         * MODIFICADO: Redução de padding (px-6 py-4 -> px-3 py-2) e fonte (text-sm -> text-xs)
         */
        function renderPivotTable(pivotData) {
            tableBodyProfessorPivot.innerHTML = '';
            
            const disciplineNames = Object.keys(pivotData).sort(); 
            const monthColumns = Object.values(MONTH_MAP_PIVOT);
            // Define a ordem das colunas no relatório
            const allRegularColumns = [...monthColumns, "Sábado"]; 

            if (disciplineNames.length > 0) {
                
                disciplineNames.forEach((disciplineName, index) => {
                    const rowData = pivotData[disciplineName];
                    const row = tableBodyProfessorPivot.insertRow();
                    row.classList.add(index % 2 === 0 ? 'bg-white' : 'bg-gray-50', 'hover:bg-gray-50');

                    // Coluna Disciplina
                    const discCell = row.insertCell();
                    discCell.textContent = disciplineName;
                    // CLASSE MODIFICADA PARA COMPACTAÇÃO E TEXTO MENOR
                    discCell.classList.add('px-3', 'py-2', 'font-medium', 'text-xs', 'text-gray-900', 'whitespace-nowrap');

                    // Colunas de Mês e Sábado
                    allRegularColumns.forEach(column => {
                        const cell = row.insertCell();
                        cell.textContent = rowData[column] || 0;
                        // CLASSE MODIFICADA PARA COMPACTAÇÃO E TEXTO MENOR
                        cell.classList.add('px-3', 'py-2', 'text-center', 'text-xs', 'text-gray-700', 'whitespace-nowrap');
                        
                        // Destaca a coluna SÁBADO
                        if (column === "Sábado") {
                            cell.classList.add('bg-gray-100', 'font-medium');
                        }
                    });
                    
                    // Coluna Total
                    const totalCell = row.insertCell();
                    totalCell.textContent = rowData.total;
                    // CLASSE MODIFICADA PARA COMPACTAÇÃO E TEXTO MENOR
                    totalCell.classList.add('px-3', 'py-2', 'text-center', 'text-xs', 'font-extrabold', 'text-ifro-primary', 'whitespace-nowrap', 'bg-green-50');
                });
                
            } else {
                const row = tableBodyProfessorPivot.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 15; // 1 (Disc) + 12 (Meses) + 1 (Sábado) + 1 (Total) = 15
                // CLASSE MODIFICADA PARA COMPACTAÇÃO E TEXTO MENOR
                cell.classList.add('px-3', 'py-2', 'text-center', 'text-xs', 'text-gray-500', 'italic');
                
                cell.textContent = 'Selecione a turma para visualizar a carga horária por disciplina e mês.';
            }
        }
        
        /**
         * Gera e descarrega o relatório PIVÔ em formato PDF da ABA 2.
         */
        async function exportProfessorPivotReportToPdf() {
            if (!turmaSelectProfessor.value) return;

            exportProfessorPdfBtn.disabled = true;
            exportProfessorPdfBtn.textContent = 'Gerando PDF...';
            showFeedback('Gerando relatório PDF...', 'bg-yellow-100 text-yellow-800');

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Paisagem para caber mais colunas
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            let y = margin;
            
            const selectedYearText = yearSelectProfessor.options[yearSelectProfessor.selectedIndex].text;
            const selectedTurmaText = turmaSelectProfessor.options[turmaSelectProfessor.selectedIndex].text;
            
            // Re-gera os dados para ter o objeto pivotData (garante que está atualizado)
            handleTurmaProfessorChange({ target: { value: turmaSelectProfessor.value } });
            const pivotData = {};
            const turmaData = processedData[turmaSelectProfessor.value].disciplines;
            
            // Lógica de preenchimento para o PDF
            for (const disciplineId in turmaData) {
                const disciplineName = turmaData[disciplineId].name;
                const initialRow = { total: 0, "Sábado": 0 };
                Object.keys(MONTH_MAP_PIVOT).forEach(monthKey => {
                    initialRow[MONTH_MAP_PIVOT[monthKey]] = 0;
                });
                pivotData[disciplineName] = initialRow;

                for (const professorId in turmaData[disciplineId].professors) {
                    const schedule = turmaData[disciplineId].professors[professorId].schedule;
                    
                    schedule.forEach(item => {
                        if (item.isRecuperacao) { return; }
                        const monthColumn = MONTH_MAP_PIVOT[item.month.toLowerCase()];
                        
                        if (monthColumn) {
                            pivotData[disciplineName][monthColumn] += 1;
                        }
                        
                        if (item.dayOfWeek.toLowerCase().includes('sábado')) {
                            pivotData[disciplineName]["Sábado"] += 1;
                        }
                        
                        pivotData[disciplineName].total += 1;
                    });
                }
            }


            const addCenteredText = (text, size, style = 'normal') => {
                doc.setFont('helvetica', style);
                doc.setFontSize(size);
                const textWidth = doc.getStringUnitWidth(text) * size / doc.internal.scaleFactor;
                const x = (pageWidth - textWidth) / 2;
                doc.text(text, x, y);
                y += size * 0.4;
            };

            y += 5;
            addCenteredText('INSTITUTO FEDERAL DE RONDÔNIA', 14, 'bold');
            addCenteredText('CAMPUS CACOAL', 12, 'italic');
            y += 5;
            addCenteredText('DEPARTAMENTO DE APOIO AO ENSINO', 10);
            addCenteredText('COORDENAÇÃO DE DESENVOLVIMENTO DE FERRAMENTAS PEDAGÓGICAS', 10);
            
            y += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(`Relatório Pivô: Disciplinas por Mês - Turma ${selectedTurmaText} - Ano ${selectedYearText}`, margin, y);
            y += 10;
            
            // Cabeçalho da tabela do PDF
            const monthColumns = Object.values(MONTH_MAP_PIVOT);
            // Inclui "Sábado" no cabeçalho
            const headers = [["Disciplina", ...monthColumns, "SÁBADO", "Total"]]; 
            
            // Dados da tabela do PDF
            const disciplineNames = Object.keys(pivotData).sort(); 
            const data = disciplineNames.map(disciplineName => {
                const rowData = pivotData[disciplineName];
                const row = [disciplineName];
                
                // Meses
                monthColumns.forEach(month => row.push(rowData[month].toString()));
                
                // Sábado
                row.push(rowData["Sábado"].toString()); 
                
                // Total
                row.push(rowData.total.toString());
                
                return row;
            });
            
            // Coluna Total deve ser verde no PDF (é a última coluna, índice 14 - 1 = 13)
            const columnStyles = {
                13: { fillColor: [22, 163, 74], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center' }
            };

            // Ajustando fonte e padding no PDF para compactar a tabela, usando fontSize 7
            doc.autoTable({
                head: headers,
                body: data,
                startY: y,
                theme: 'striped',
                headStyles: { fillColor: [22, 163, 74], fontStyle: 'bold', halign: 'center' },
                styles: { fontSize: 7, cellPadding: 1.5, halign: 'center' }, // Font size 7 e padding 1.5
                columnStyles: columnStyles,
                margin: { top: margin, bottom: margin, left: margin, right: margin },
                didDrawPage: function (data) {
                    const footerText = `${dataRelatorioSpan.textContent} / Campus Cacoal`;
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    const textWidth = doc.getStringUnitWidth(footerText) * 8 / doc.internal.scaleFactor;
                    const x = (pageWidth - textWidth) / 2;
                    doc.text(footerText, x, doc.internal.pageSize.getHeight() - 10);
                }
            });

            const fileName = `Relatorio_Pivo_${selectedYearText}_${selectedTurmaText.replace(/\s/g, '_')}.pdf`;
            doc.save(fileName);

            exportProfessorPdfBtn.disabled = false;
            exportProfessorPdfBtn.textContent = 'Exportar Relatório em PDF (Turma)';
            showFeedback('Relatório PDF gerado com sucesso!', 'bg-green-100 text-green-800');
        }

        /**
         * Exibe uma mensagem de feedback temporária no UI.
         */
        function showFeedback(message, className) {
            feedbackMessage.classList.remove('hidden', 'bg-yellow-100', 'text-yellow-800', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
            feedbackMessage.classList.add(...className.split(' ')); 
            feedbackMessage.textContent = message;
            
            setTimeout(() => {
                feedbackMessage.classList.add('hidden');
            }, 5000); 
        }

        // Inicializa a aplicação ao carregar a página
        document.addEventListener('DOMContentLoaded', () => {
             // Carrega o plugin autoTable (necessário para o PDF)
            const autoTableScript = document.createElement('script');
            autoTableScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js';
            document.head.appendChild(autoTableScript);

            autoTableScript.onload = initApp;
        });
// Constantes auxiliares para a Grade
const HORARIOS_GRADE = ["07:30", "08:20", "09:30", "10:20", "11:10", "13:50", "14:40", "15:50", "16:40", "17:30", "19:00", "19:50", "20:50", "21:40"];
const MAPA_MESES_INDEX = { "janeiro": 0, "fevereiro": 1, "março": 2, "abril": 3, "maio": 4, "junho": 5, "julho": 6, "agosto": 7, "setembro": 8, "outubro": 9, "novembro": 10, "dezembro": 11 };

// Função para listar os professores na nova aba
       function populateProfessoresGrade() {
    const select = document.getElementById('selectProfSemanal');
    if (!select) return;

    select.innerHTML = '<option value="">-- Selecione o Professor --</option>';
    const listaProfessores = new Set();
    
    if (typeof processedData !== 'undefined') {
        for (const tId in processedData) {
            for (const dId in processedData[tId].disciplines) {
                for (const pId in processedData[tId].disciplines[dId].professors) {
                    let nomeOriginal = processedData[tId].disciplines[dId].professors[pId].name;
                    
                    if (nomeOriginal) {
                        // Limpa (REC), (Exame), etc., e remove espaços extras
                        let nomeLimpo = nomeOriginal.replace(/\(.*\)/g, '').trim();
                        listaProfessores.add(nomeLimpo);
                    }
                }
            }
        }
    }

    if (listaProfessores.size > 0) {
        const ordenados = Array.from(listaProfessores).sort();
        ordenados.forEach(prof => {
            const option = document.createElement('option');
            option.value = prof;
            option.textContent = prof;
            select.appendChild(option);
        });
        select.disabled = false;
    }
}
        
function atualizarListaProfessoresSemanal() {
    const select = document.getElementById('selectProfSemanal');
    const professores = new Set();
    
    // Varre seu objeto processedData original
    for (let tId in processedData) {
        for (let dId in processedData[tId].disciplines) {
            for (let pId in processedData[tId].disciplines[dId].professors) {
                professores.add(processedData[tId].disciplines[dId].professors[pId].name);
            }
        }
    }

    const listaOrdenada = Array.from(professores).sort();
    select.innerHTML = '<option value="">-- Selecione o Professor --</option>' + 
        listaOrdenada.map(p => `<option value="${p}">${p}</option>`).join('');
}

// Cálculo da semana do ano
function getNumeroSemana(data) {
    const d = new Date(Date.UTC(data.getFullYear(), data.getMonth(), data.getDate()));
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
    const anoInicio = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - anoInicio) / 86400000) + 1) / 7);
}

// Função principal da nova Aba
// FORÇAR ATRIBUIÇÃO DO BOTÃO AO CARREGAR A PÁGINA
// FORÇAR A FUNÇÃO PARA O ESCOPO GLOBAL
window.gerarGradeSemanal = function() {
    const elProf = document.getElementById('selectProfSemanal');
    const elSemana = document.getElementById('inputSemana');
    const elResult = document.getElementById('gradeSemanalResult');

    if (!elProf || !elSemana || !elResult) return;

    const profAlvo = elProf.value;
    const semanaInput = elSemana.value; 
    if (!profAlvo || !semanaInput) {
        alert("Selecione o professor e a semana.");
        return;
    }

    const [anoAlvo, numSemanaAlvo] = semanaInput.split('-W').map(Number);
    const database = (typeof processedData !== 'undefined') ? processedData : null;
    if (!database) return;

    // 1. DESCOBRIR AS DATAS REAIS DA SEMANA
    function getDatesOfWeek(year, week) {
        let d = new Date(year, 0, 1);
        let dayNum = d.getDay() || 7;
        let diff = (week - 1) * 7 + (1 - dayNum);
        let monday = new Date(year, 0, 1 + diff);
        let map = {};
        const nomes = ["Segunda-feira", "Terça-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "Sábado"];
        nomes.forEach((nome, i) => {
            let date = new Date(monday);
            date.setDate(monday.getDate() + i);
            map[nome] = { dia: date.getDate(), mes: date.getMonth() };
        });
        return map;
    }

    const mapaDatas = getDatesOfWeek(anoAlvo, numSemanaAlvo);
    const slotsHorario = ["07:30", "08:20", "09:30", "10:20", "11:10", "13:50", "14:40", "15:50", "16:40", "17:30", "19:00", "19:50", "20:50", "21:40"];
    const mesesNomes = ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro", "marco"];

    let html = `<table class="min-w-full border-collapse border border-gray-200 text-[10px] bg-white text-center shadow-md">
        <thead>
            <tr class="bg-green-700 text-white font-bold">
                <th class="border p-2 w-16">HORÁRIO</th>
                ${Object.keys(mapaDatas).map(d => `<th class="border p-1">${d.toUpperCase()}<br><span class="font-normal text-[8px]">${mapaDatas[d].dia}/${mapaDatas[d].mes+1}</span></th>`).join('')}
            </tr>
        </thead><tbody>`;

    let encontrouAlgo = false;

    slotsHorario.forEach(slot => {
        html += `<tr><td class="border p-2 font-bold bg-gray-50 text-gray-700">${slot}</td>`;
        
        Object.keys(mapaDatas).forEach(diaNome => {
            const dataAlvo = mapaDatas[diaNome];
            let conteudoCell = "";
            let disciplinasJaAdd = new Set(); // IMPEDE DUPLICAÇÃO NA CÉLULA

            for (const tId in database) {
                for (const dId in database[tId].disciplines) {
                    const disc = database[tId].disciplines[dId];
                    for (const pId in disc.professors) {
                        const prof = disc.professors[pId];
                        let pLimpo = prof.name.replace(/\(.*\)/g, '').trim();

                        if (pLimpo === profAlvo) {
                            prof.schedule.forEach(aula => {
                                // NORMALIZAÇÃO DA HORA: Pega apenas os primeiros 5 caracteres (ex: "07:30")
                                const horaReduzida = aula.time.trim().substring(0, 5);
                                let mIdx = mesesNomes.indexOf(aula.month.toLowerCase().trim());
                                if (mIdx === 12) mIdx = 2;

                                // COMPARAÇÃO RÍGIDA DE DATA E HORA
                                if (horaReduzida === slot && 
                                    aula.dayOfMonth === dataAlvo.dia && 
                                    mIdx === dataAlvo.mes) {
                                    
                                    // CHAVE PARA EVITAR DUPLICAR A MESMA DISCIPLINA NO MESMO QUADRADO
                                    const chaveUnica = `${disc.name}-${database[tId].name}`;
                                    
                                    if (!disciplinasJaAdd.has(chaveUnica)) {
                                        encontrouAlgo = true;
                                        disciplinasJaAdd.add(chaveUnica);
                                        const cor = aula.isRecuperacao ? 'bg-yellow-100 border-yellow-300' : 'bg-green-50 border-green-200';
                                        
                                        conteudoCell += `<div class="${cor} p-1 mb-1 rounded border text-[9px] leading-tight shadow-sm">
                                            <div class="font-bold text-gray-800">${disc.name}</div>
                                            <div class="text-[7px] opacity-75">${database[tId].name}</div>
                                        </div>`;
                                    }
                                }
                            });
                        }
                    }
                }
            }
            html += `<td class="border p-1 w-32 h-14 bg-white align-top">${conteudoCell}</td>`;
        });
        html += `</tr>`;
    });

    elResult.innerHTML = html + "</tbody></table>";
    if (!encontrouAlgo) elResult.innerHTML += `<p class="p-8 text-center text-gray-400 italic">Nenhuma aula encontrada.</p>`;
};
  window.exportarGradeSemanalPDF = function() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4'); // Paisagem para caber os dias
    
    const prof = document.getElementById('selectProfSemanal').value;
    const semanaRaw = document.getElementById('inputSemana').value;
    const tabela = document.querySelector('#gradeSemanalResult table');

    if (!tabela || !prof) {
        alert("Por favor, gere a grade antes de exportar.");
        return;
    }

    // --- CONFIGURAÇÃO DE TEXTO CENTRALIZADO ---
    const pageWidth = doc.internal.pageSize.getWidth();
    const centerText = (text, y, size, style = 'normal') => {
        doc.setFontSize(size);
        doc.setFont('helvetica', style);
        const textWidth = doc.getTextWidth(text);
        doc.text(text, (pageWidth - textWidth) / 2, y);
    };

    // --- CABEÇALHO OFICIAL (IGUAL À IMAGEM) ---
    centerText("INSTITUTO FEDERAL DE RONDÔNIA", 15, 16, 'bold');
    centerText("CAMPUS CACOAL", 22, 14, 'italic');
    
    centerText("DEPARTAMENTO DE APOIO AO ENSINO", 35, 11, 'normal');
    centerText("COORDENAÇÃO DE DESENVOLVIMENTO DE FERRAMENTAS PEDAGÓGICAS", 42, 11, 'normal');

    // --- INFORMAÇÕES DO RELATÓRIO ---
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.text(`Relatório de Horários de Aula (Grade Semanal) - Ano ${semanaRaw.split('-')[0]}`, 14, 55);
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(11);
    doc.text(`Professor: ${prof}`, 14, 62);
    doc.text(`Semana Selecionada: ${semanaRaw}`, 14, 68);

    // --- GERAÇÃO DA TABELA ---
    doc.autoTable({
        html: tabela,
        startY: 75,
        theme: 'grid',
        styles: {
            fontSize: 7,
            cellPadding: 2,
            valign: 'middle',
            halign: 'center',
            lineColor: [200, 200, 200],
            lineWidth: 0.1
        },
        headStyles: {
            fillColor: [21, 128, 61], // Verde oficial IFRO
            textColor: [255, 255, 255],
            fontSize: 8,
            fontStyle: 'bold'
        },
        columnStyles: {
            0: { fontStyle: 'bold', fillColor: [245, 245, 245], cellWidth: 22 }
        },
        didParseCell: function(data) {
            // Limpa o texto vindo do HTML (disciplina + turma)
            if (data.cell.raw && data.cell.raw.innerText) {
                data.cell.text = data.cell.raw.innerText.trim();
            }
        }
    });

    // Nome do arquivo padronizado
    const fileName = `Grade_Semanal_${prof.replace(/\s+/g, '_')}_${semanaRaw}.pdf`;
    doc.save(fileName);
};
// IMPORTANTE: Chame esta função dentro da sua função original 'initApp' ou 'processAndRenderData'
// Para garantir que a lista de professores carregue assim que o arquivo for aberto:
// atualizarListaProfessoresSemanal();
    </script>

</body>
</html>
